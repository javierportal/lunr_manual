<html><head><meta content="text/html; charset=UTF-8" http-equiv="content-type"><style type="text/css">@import url(https://themes.googleusercontent.com/fonts/css?kit=XGMkxXUZTA64h2imyzu79g);.lst-kix_cei76fufwbsa-6>li:before{content:"\0025cf   "}.lst-kix_cei76fufwbsa-7>li:before{content:"\0025cb   "}ol.lst-kix_i6uk1nmxf1v5-3.start{counter-reset:lst-ctn-kix_i6uk1nmxf1v5-3 0}.lst-kix_cei76fufwbsa-8>li:before{content:"\0025a0   "}.lst-kix_5r6xq1gg8hbq-3>li:before{content:"\0025cf   "}.lst-kix_5r6xq1gg8hbq-4>li:before{content:"\0025cb   "}.lst-kix_i6uk1nmxf1v5-3>li{counter-increment:lst-ctn-kix_i6uk1nmxf1v5-3}.lst-kix_5r6xq1gg8hbq-1>li:before{content:"\0025cb   "}.lst-kix_5r6xq1gg8hbq-5>li:before{content:"\0025a0   "}.lst-kix_5r6xq1gg8hbq-0>li:before{content:"\0025cf   "}.lst-kix_5r6xq1gg8hbq-7>li:before{content:"\0025cb   "}.lst-kix_5r6xq1gg8hbq-8>li:before{content:"\0025a0   "}.lst-kix_cei76fufwbsa-5>li:before{content:"\0025a0   "}.lst-kix_5r6xq1gg8hbq-6>li:before{content:"\0025cf   "}.lst-kix_cei76fufwbsa-4>li:before{content:"\0025cb   "}.lst-kix_cei76fufwbsa-3>li:before{content:"\0025cf   "}ul.lst-kix_646hftmegucp-5{list-style-type:none}ul.lst-kix_646hftmegucp-4{list-style-type:none}ul.lst-kix_646hftmegucp-7{list-style-type:none}ul.lst-kix_646hftmegucp-6{list-style-type:none}ul.lst-kix_646hftmegucp-1{list-style-type:none}ul.lst-kix_646hftmegucp-0{list-style-type:none}.lst-kix_cei76fufwbsa-2>li:before{content:"\0025a0   "}ul.lst-kix_646hftmegucp-3{list-style-type:none}ul.lst-kix_646hftmegucp-2{list-style-type:none}.lst-kix_cei76fufwbsa-1>li:before{content:"\0025cb   "}.lst-kix_5r6xq1gg8hbq-2>li:before{content:"\0025a0   "}ul.lst-kix_646hftmegucp-8{list-style-type:none}.lst-kix_cei76fufwbsa-0>li:before{content:"\0025cf   "}.lst-kix_646hftmegucp-7>li:before{content:"\0025cb   "}.lst-kix_646hftmegucp-6>li:before{content:"\0025cf   "}.lst-kix_646hftmegucp-8>li:before{content:"\0025a0   "}.lst-kix_646hftmegucp-5>li:before{content:"\0025a0   "}.lst-kix_veh6wb5gno53-6>li:before{content:"\0025cf   "}.lst-kix_veh6wb5gno53-5>li:before{content:"\0025a0   "}.lst-kix_veh6wb5gno53-4>li:before{content:"\0025cb   "}.lst-kix_veh6wb5gno53-7>li:before{content:"\0025cb   "}.lst-kix_veh6wb5gno53-8>li:before{content:"\0025a0   "}.lst-kix_646hftmegucp-0>li:before{content:"\0025cf   "}.lst-kix_veh6wb5gno53-1>li:before{content:"\0025cb   "}.lst-kix_veh6wb5gno53-3>li:before{content:"\0025cf   "}.lst-kix_646hftmegucp-1>li:before{content:"\0025cb   "}.lst-kix_veh6wb5gno53-2>li:before{content:"\0025a0   "}.lst-kix_646hftmegucp-3>li:before{content:"\0025cf   "}.lst-kix_646hftmegucp-2>li:before{content:"\0025a0   "}.lst-kix_646hftmegucp-4>li:before{content:"\0025cb   "}.lst-kix_veh6wb5gno53-0>li:before{content:"\0025cf   "}ul.lst-kix_5r6xq1gg8hbq-1{list-style-type:none}ul.lst-kix_5r6xq1gg8hbq-2{list-style-type:none}ul.lst-kix_5r6xq1gg8hbq-0{list-style-type:none}ol.lst-kix_i6uk1nmxf1v5-5.start{counter-reset:lst-ctn-kix_i6uk1nmxf1v5-5 0}.lst-kix_tbt3fp5mpfdn-0>li:before{content:"\0025cf   "}.lst-kix_i6uk1nmxf1v5-6>li{counter-increment:lst-ctn-kix_i6uk1nmxf1v5-6}.lst-kix_oqjom6a2yix0-8>li:before{content:"\0025a0   "}.lst-kix_m9hl1rm2thn6-7>li:before{content:"\0025cb   "}.lst-kix_oqjom6a2yix0-6>li:before{content:"\0025cf   "}.lst-kix_oqjom6a2yix0-2>li:before{content:"\0025a0   "}.lst-kix_oqjom6a2yix0-4>li:before{content:"\0025cb   "}ol.lst-kix_i6uk1nmxf1v5-8.start{counter-reset:lst-ctn-kix_i6uk1nmxf1v5-8 0}.lst-kix_oqjom6a2yix0-0>li:before{content:"\0025cf   "}ul.lst-kix_5r6xq1gg8hbq-7{list-style-type:none}ul.lst-kix_5r6xq1gg8hbq-8{list-style-type:none}ul.lst-kix_5r6xq1gg8hbq-5{list-style-type:none}ul.lst-kix_5r6xq1gg8hbq-6{list-style-type:none}ul.lst-kix_5r6xq1gg8hbq-3{list-style-type:none}ul.lst-kix_5r6xq1gg8hbq-4{list-style-type:none}.lst-kix_m9hl1rm2thn6-1>li:before{content:"\0025cb   "}.lst-kix_m9hl1rm2thn6-3>li:before{content:"\0025cf   "}.lst-kix_m9hl1rm2thn6-5>li:before{content:"\0025a0   "}.lst-kix_z68r28hjx3of-7>li:before{content:"\0025cb   "}.lst-kix_z68r28hjx3of-8>li:before{content:"\0025a0   "}.lst-kix_t8id0ej4c58t-5>li:before{content:"\0025a0   "}.lst-kix_t8id0ej4c58t-6>li:before{content:"\0025cf   "}.lst-kix_b2fvdmaxdt7-8>li:before{content:"\0025a0   "}.lst-kix_b2fvdmaxdt7-4>li:before{content:"\0025cb   "}.lst-kix_b2fvdmaxdt7-5>li:before{content:"\0025a0   "}.lst-kix_1emiwc70v2fc-3>li:before{content:"\0025cf   "}.lst-kix_1emiwc70v2fc-4>li:before{content:"\0025cb   "}.lst-kix_1emiwc70v2fc-7>li:before{content:"\0025cb   "}.lst-kix_b2fvdmaxdt7-0>li:before{content:"\0025cf   "}.lst-kix_b2fvdmaxdt7-1>li:before{content:"\0025cb   "}.lst-kix_1emiwc70v2fc-8>li:before{content:"\0025a0   "}.lst-kix_n78w9728jq9m-8>li:before{content:"\0025a0   "}.lst-kix_n78w9728jq9m-7>li:before{content:"\0025cb   "}ul.lst-kix_l532cjf69trz-1{list-style-type:none}ul.lst-kix_l532cjf69trz-2{list-style-type:none}.lst-kix_q6e5llwbj00b-5>li:before{content:"\0025a0   "}.lst-kix_q6e5llwbj00b-6>li:before{content:"\0025cf   "}ul.lst-kix_l532cjf69trz-0{list-style-type:none}ul.lst-kix_mvx7bf7jy6x0-6{list-style-type:none}.lst-kix_n78w9728jq9m-0>li:before{content:"\0025cf   "}.lst-kix_n78w9728jq9m-4>li:before{content:"\0025cb   "}ul.lst-kix_l532cjf69trz-5{list-style-type:none}ul.lst-kix_mvx7bf7jy6x0-5{list-style-type:none}ul.lst-kix_l532cjf69trz-6{list-style-type:none}ul.lst-kix_mvx7bf7jy6x0-8{list-style-type:none}.lst-kix_n78w9728jq9m-3>li:before{content:"\0025cf   "}ul.lst-kix_l532cjf69trz-3{list-style-type:none}ul.lst-kix_mvx7bf7jy6x0-7{list-style-type:none}ul.lst-kix_l532cjf69trz-4{list-style-type:none}ul.lst-kix_mvx7bf7jy6x0-2{list-style-type:none}ul.lst-kix_mvx7bf7jy6x0-1{list-style-type:none}.lst-kix_q6e5llwbj00b-1>li:before{content:"\0025cb   "}.lst-kix_q6e5llwbj00b-2>li:before{content:"\0025a0   "}ul.lst-kix_mvx7bf7jy6x0-4{list-style-type:none}ul.lst-kix_l532cjf69trz-7{list-style-type:none}ul.lst-kix_mvx7bf7jy6x0-3{list-style-type:none}ul.lst-kix_l532cjf69trz-8{list-style-type:none}ul.lst-kix_mvx7bf7jy6x0-0{list-style-type:none}.lst-kix_tbt3fp5mpfdn-2>li:before{content:"\0025a0   "}.lst-kix_tbt3fp5mpfdn-3>li:before{content:"\0025cf   "}.lst-kix_c7i1dok25hqo-7>li:before{content:"\0025cb   "}.lst-kix_tbt3fp5mpfdn-7>li:before{content:"\0025cb   "}.lst-kix_tbt3fp5mpfdn-6>li:before{content:"\0025cf   "}.lst-kix_i6uk1nmxf1v5-2>li:before{content:"" counter(lst-ctn-kix_i6uk1nmxf1v5-2,lower-roman) ". "}.lst-kix_1emiwc70v2fc-0>li:before{content:"\0025cf   "}.lst-kix_i6uk1nmxf1v5-1>li:before{content:"" counter(lst-ctn-kix_i6uk1nmxf1v5-1,lower-latin) ". "}.lst-kix_c7i1dok25hqo-0>li:before{content:"\0025cf   "}.lst-kix_c7i1dok25hqo-8>li:before{content:"\0025a0   "}.lst-kix_z68r28hjx3of-0>li:before{content:"\0025cf   "}.lst-kix_i6uk1nmxf1v5-6>li:before{content:"" counter(lst-ctn-kix_i6uk1nmxf1v5-6,decimal) ". "}.lst-kix_t8id0ej4c58t-2>li:before{content:"\0025a0   "}.lst-kix_c7i1dok25hqo-3>li:before{content:"\0025cf   "}.lst-kix_z68r28hjx3of-3>li:before{content:"\0025cf   "}.lst-kix_z68r28hjx3of-4>li:before{content:"\0025cb   "}.lst-kix_i6uk1nmxf1v5-5>li:before{content:"" counter(lst-ctn-kix_i6uk1nmxf1v5-5,lower-roman) ". "}.lst-kix_c7i1dok25hqo-4>li:before{content:"\0025cb   "}.lst-kix_t8id0ej4c58t-1>li:before{content:"\0025cb   "}ul.lst-kix_oc3r6ynugb1-8{list-style-type:none}ul.lst-kix_ye6sj6eonblf-2{list-style-type:none}ul.lst-kix_ye6sj6eonblf-3{list-style-type:none}ul.lst-kix_ye6sj6eonblf-0{list-style-type:none}ul.lst-kix_ye6sj6eonblf-1{list-style-type:none}ul.lst-kix_oc3r6ynugb1-3{list-style-type:none}.lst-kix_l532cjf69trz-6>li:before{content:"\0025cf   "}ul.lst-kix_oc3r6ynugb1-2{list-style-type:none}ul.lst-kix_oc3r6ynugb1-1{list-style-type:none}ul.lst-kix_oc3r6ynugb1-0{list-style-type:none}ul.lst-kix_oc3r6ynugb1-7{list-style-type:none}ul.lst-kix_oc3r6ynugb1-6{list-style-type:none}.lst-kix_oc3r6ynugb1-3>li:before{content:"\0025cf   "}ul.lst-kix_oc3r6ynugb1-5{list-style-type:none}ul.lst-kix_oc3r6ynugb1-4{list-style-type:none}.lst-kix_l532cjf69trz-2>li:before{content:"\0025a0   "}.lst-kix_i6uk1nmxf1v5-8>li{counter-increment:lst-ctn-kix_i6uk1nmxf1v5-8}ul.lst-kix_ye6sj6eonblf-6{list-style-type:none}ul.lst-kix_ye6sj6eonblf-7{list-style-type:none}ul.lst-kix_ye6sj6eonblf-4{list-style-type:none}ul.lst-kix_ye6sj6eonblf-5{list-style-type:none}.lst-kix_oc3r6ynugb1-7>li:before{content:"\0025cb   "}ul.lst-kix_ye6sj6eonblf-8{list-style-type:none}ul.lst-kix_z68r28hjx3of-1{list-style-type:none}ul.lst-kix_z68r28hjx3of-2{list-style-type:none}ul.lst-kix_z68r28hjx3of-3{list-style-type:none}ul.lst-kix_z68r28hjx3of-4{list-style-type:none}ul.lst-kix_z68r28hjx3of-5{list-style-type:none}ul.lst-kix_z68r28hjx3of-6{list-style-type:none}ul.lst-kix_z68r28hjx3of-7{list-style-type:none}ul.lst-kix_z68r28hjx3of-8{list-style-type:none}.lst-kix_oqjom6a2yix0-5>li:before{content:"\0025a0   "}ul.lst-kix_z68r28hjx3of-0{list-style-type:none}.lst-kix_oqjom6a2yix0-1>li:before{content:"\0025cb   "}.lst-kix_eg5uqg7xak1w-7>li:before{content:"\0025cb   "}.lst-kix_mvx7bf7jy6x0-2>li:before{content:"\0025a0   "}.lst-kix_mvx7bf7jy6x0-6>li:before{content:"\0025cf   "}.lst-kix_m9hl1rm2thn6-2>li:before{content:"\0025a0   "}.lst-kix_m9hl1rm2thn6-6>li:before{content:"\0025cf   "}ol.lst-kix_i6uk1nmxf1v5-4{list-style-type:none}ol.lst-kix_i6uk1nmxf1v5-5{list-style-type:none}ol.lst-kix_i6uk1nmxf1v5-2{list-style-type:none}ol.lst-kix_i6uk1nmxf1v5-3{list-style-type:none}ol.lst-kix_i6uk1nmxf1v5-8{list-style-type:none}ol.lst-kix_i6uk1nmxf1v5-6{list-style-type:none}ol.lst-kix_i6uk1nmxf1v5-7{list-style-type:none}.lst-kix_ye6sj6eonblf-3>li:before{content:"\0025cf   "}.lst-kix_ye6sj6eonblf-4>li:before{content:"\0025cb   "}ol.lst-kix_i6uk1nmxf1v5-0{list-style-type:none}ol.lst-kix_i6uk1nmxf1v5-1{list-style-type:none}.lst-kix_67ck7kjdyeu1-8>li:before{content:"\0025a0   "}.lst-kix_ye6sj6eonblf-6>li:before{content:"\0025cf   "}.lst-kix_ye6sj6eonblf-5>li:before{content:"\0025a0   "}.lst-kix_ye6sj6eonblf-7>li:before{content:"\0025cb   "}.lst-kix_i6uk1nmxf1v5-1>li{counter-increment:lst-ctn-kix_i6uk1nmxf1v5-1}.lst-kix_eg5uqg7xak1w-6>li:before{content:"\0025cf   "}.lst-kix_eg5uqg7xak1w-5>li:before{content:"\0025a0   "}.lst-kix_eg5uqg7xak1w-4>li:before{content:"\0025cb   "}.lst-kix_eg5uqg7xak1w-2>li:before{content:"\0025a0   "}.lst-kix_eg5uqg7xak1w-1>li:before{content:"\0025cb   "}.lst-kix_eg5uqg7xak1w-3>li:before{content:"\0025cf   "}.lst-kix_ye6sj6eonblf-2>li:before{content:"\0025a0   "}.lst-kix_ye6sj6eonblf-1>li:before{content:"\0025cb   "}.lst-kix_ye6sj6eonblf-0>li:before{content:"\0025cf   "}.lst-kix_eg5uqg7xak1w-0>li:before{content:"\0025cf   "}ol.lst-kix_i6uk1nmxf1v5-4.start{counter-reset:lst-ctn-kix_i6uk1nmxf1v5-4 0}.lst-kix_67ck7kjdyeu1-4>li:before{content:"\0025cb   "}.lst-kix_67ck7kjdyeu1-3>li:before{content:"\0025cf   "}.lst-kix_67ck7kjdyeu1-5>li:before{content:"\0025a0   "}.lst-kix_ye6sj6eonblf-8>li:before{content:"\0025a0   "}.lst-kix_67ck7kjdyeu1-0>li:before{content:"\0025cf   "}.lst-kix_67ck7kjdyeu1-7>li:before{content:"\0025cb   "}.lst-kix_67ck7kjdyeu1-6>li:before{content:"\0025cf   "}.lst-kix_67ck7kjdyeu1-1>li:before{content:"\0025cb   "}.lst-kix_oc3r6ynugb1-0>li:before{content:"\0025cf   "}.lst-kix_67ck7kjdyeu1-2>li:before{content:"\0025a0   "}.lst-kix_oc3r6ynugb1-2>li:before{content:"\0025a0   "}ul.lst-kix_c7i1dok25hqo-1{list-style-type:none}ul.lst-kix_c7i1dok25hqo-0{list-style-type:none}ul.lst-kix_tbt3fp5mpfdn-5{list-style-type:none}ul.lst-kix_veh6wb5gno53-6{list-style-type:none}.lst-kix_mvx7bf7jy6x0-7>li:before{content:"\0025cb   "}ul.lst-kix_tbt3fp5mpfdn-4{list-style-type:none}ul.lst-kix_veh6wb5gno53-7{list-style-type:none}.lst-kix_l532cjf69trz-7>li:before{content:"\0025cb   "}ul.lst-kix_tbt3fp5mpfdn-3{list-style-type:none}ul.lst-kix_veh6wb5gno53-4{list-style-type:none}ul.lst-kix_tbt3fp5mpfdn-2{list-style-type:none}ul.lst-kix_veh6wb5gno53-5{list-style-type:none}ul.lst-kix_b2fvdmaxdt7-0{list-style-type:none}.lst-kix_oc3r6ynugb1-4>li:before{content:"\0025cb   "}ul.lst-kix_veh6wb5gno53-2{list-style-type:none}ul.lst-kix_b2fvdmaxdt7-1{list-style-type:none}ul.lst-kix_tbt3fp5mpfdn-8{list-style-type:none}ul.lst-kix_veh6wb5gno53-3{list-style-type:none}ul.lst-kix_tbt3fp5mpfdn-7{list-style-type:none}ul.lst-kix_veh6wb5gno53-0{list-style-type:none}ul.lst-kix_tbt3fp5mpfdn-6{list-style-type:none}ul.lst-kix_veh6wb5gno53-1{list-style-type:none}ul.lst-kix_b2fvdmaxdt7-4{list-style-type:none}ul.lst-kix_b2fvdmaxdt7-5{list-style-type:none}ul.lst-kix_b2fvdmaxdt7-2{list-style-type:none}.lst-kix_l532cjf69trz-1>li:before{content:"\0025cb   "}.lst-kix_l532cjf69trz-3>li:before{content:"\0025cf   "}ul.lst-kix_b2fvdmaxdt7-3{list-style-type:none}ul.lst-kix_b2fvdmaxdt7-8{list-style-type:none}ul.lst-kix_tbt3fp5mpfdn-1{list-style-type:none}ul.lst-kix_tbt3fp5mpfdn-0{list-style-type:none}ul.lst-kix_b2fvdmaxdt7-6{list-style-type:none}ul.lst-kix_b2fvdmaxdt7-7{list-style-type:none}.lst-kix_oc3r6ynugb1-6>li:before{content:"\0025cf   "}.lst-kix_l532cjf69trz-5>li:before{content:"\0025a0   "}.lst-kix_oc3r6ynugb1-8>li:before{content:"\0025a0   "}ul.lst-kix_veh6wb5gno53-8{list-style-type:none}ul.lst-kix_c7i1dok25hqo-8{list-style-type:none}ul.lst-kix_c7i1dok25hqo-7{list-style-type:none}ul.lst-kix_c7i1dok25hqo-6{list-style-type:none}ul.lst-kix_c7i1dok25hqo-5{list-style-type:none}ul.lst-kix_c7i1dok25hqo-4{list-style-type:none}ul.lst-kix_c7i1dok25hqo-3{list-style-type:none}ul.lst-kix_c7i1dok25hqo-2{list-style-type:none}.lst-kix_i6uk1nmxf1v5-5>li{counter-increment:lst-ctn-kix_i6uk1nmxf1v5-5}.lst-kix_eg5uqg7xak1w-8>li:before{content:"\0025a0   "}.lst-kix_mvx7bf7jy6x0-3>li:before{content:"\0025cf   "}.lst-kix_mvx7bf7jy6x0-1>li:before{content:"\0025cb   "}.lst-kix_mvx7bf7jy6x0-5>li:before{content:"\0025a0   "}ol.lst-kix_i6uk1nmxf1v5-7.start{counter-reset:lst-ctn-kix_i6uk1nmxf1v5-7 0}.lst-kix_z68r28hjx3of-5>li:before{content:"\0025a0   "}.lst-kix_z68r28hjx3of-6>li:before{content:"\0025cf   "}.lst-kix_t8id0ej4c58t-4>li:before{content:"\0025cb   "}.lst-kix_b2fvdmaxdt7-6>li:before{content:"\0025cf   "}.lst-kix_b2fvdmaxdt7-7>li:before{content:"\0025cb   "}.lst-kix_t8id0ej4c58t-7>li:before{content:"\0025cb   "}.lst-kix_1emiwc70v2fc-2>li:before{content:"\0025a0   "}ol.lst-kix_i6uk1nmxf1v5-6.start{counter-reset:lst-ctn-kix_i6uk1nmxf1v5-6 0}.lst-kix_t8id0ej4c58t-8>li:before{content:"\0025a0   "}.lst-kix_1emiwc70v2fc-6>li:before{content:"\0025cf   "}.lst-kix_1emiwc70v2fc-5>li:before{content:"\0025a0   "}.lst-kix_i6uk1nmxf1v5-0>li{counter-increment:lst-ctn-kix_i6uk1nmxf1v5-0}ul.lst-kix_t8id0ej4c58t-8{list-style-type:none}ul.lst-kix_1emiwc70v2fc-0{list-style-type:none}ul.lst-kix_t8id0ej4c58t-7{list-style-type:none}ul.lst-kix_1emiwc70v2fc-1{list-style-type:none}ul.lst-kix_t8id0ej4c58t-6{list-style-type:none}ul.lst-kix_1emiwc70v2fc-2{list-style-type:none}ul.lst-kix_t8id0ej4c58t-5{list-style-type:none}ul.lst-kix_eg5uqg7xak1w-7{list-style-type:none}.lst-kix_b2fvdmaxdt7-2>li:before{content:"\0025a0   "}.lst-kix_b2fvdmaxdt7-3>li:before{content:"\0025cf   "}ul.lst-kix_eg5uqg7xak1w-6{list-style-type:none}ul.lst-kix_eg5uqg7xak1w-5{list-style-type:none}ul.lst-kix_eg5uqg7xak1w-4{list-style-type:none}ul.lst-kix_eg5uqg7xak1w-3{list-style-type:none}ul.lst-kix_eg5uqg7xak1w-2{list-style-type:none}ul.lst-kix_eg5uqg7xak1w-1{list-style-type:none}ul.lst-kix_eg5uqg7xak1w-0{list-style-type:none}.lst-kix_q6e5llwbj00b-0>li:before{content:"\0025cf   "}ul.lst-kix_eg5uqg7xak1w-8{list-style-type:none}ul.lst-kix_1emiwc70v2fc-3{list-style-type:none}.lst-kix_n78w9728jq9m-6>li:before{content:"\0025cf   "}ul.lst-kix_t8id0ej4c58t-4{list-style-type:none}ul.lst-kix_1emiwc70v2fc-4{list-style-type:none}ul.lst-kix_t8id0ej4c58t-3{list-style-type:none}ul.lst-kix_1emiwc70v2fc-5{list-style-type:none}ul.lst-kix_t8id0ej4c58t-2{list-style-type:none}ul.lst-kix_67ck7kjdyeu1-1{list-style-type:none}ul.lst-kix_1emiwc70v2fc-6{list-style-type:none}ul.lst-kix_t8id0ej4c58t-1{list-style-type:none}ul.lst-kix_67ck7kjdyeu1-0{list-style-type:none}ul.lst-kix_1emiwc70v2fc-7{list-style-type:none}ul.lst-kix_t8id0ej4c58t-0{list-style-type:none}ul.lst-kix_1emiwc70v2fc-8{list-style-type:none}.lst-kix_n78w9728jq9m-5>li:before{content:"\0025a0   "}.lst-kix_n78w9728jq9m-2>li:before{content:"\0025a0   "}ul.lst-kix_67ck7kjdyeu1-7{list-style-type:none}ul.lst-kix_67ck7kjdyeu1-6{list-style-type:none}ul.lst-kix_67ck7kjdyeu1-8{list-style-type:none}ul.lst-kix_67ck7kjdyeu1-3{list-style-type:none}.lst-kix_q6e5llwbj00b-4>li:before{content:"\0025cb   "}.lst-kix_q6e5llwbj00b-8>li:before{content:"\0025a0   "}ul.lst-kix_67ck7kjdyeu1-2{list-style-type:none}ul.lst-kix_67ck7kjdyeu1-5{list-style-type:none}ul.lst-kix_67ck7kjdyeu1-4{list-style-type:none}.lst-kix_q6e5llwbj00b-3>li:before{content:"\0025cf   "}.lst-kix_n78w9728jq9m-1>li:before{content:"\0025cb   "}ul.lst-kix_m9hl1rm2thn6-0{list-style-type:none}ul.lst-kix_m9hl1rm2thn6-1{list-style-type:none}.lst-kix_tbt3fp5mpfdn-1>li:before{content:"\0025cb   "}ul.lst-kix_m9hl1rm2thn6-2{list-style-type:none}ul.lst-kix_m9hl1rm2thn6-3{list-style-type:none}ul.lst-kix_m9hl1rm2thn6-4{list-style-type:none}ul.lst-kix_m9hl1rm2thn6-5{list-style-type:none}ul.lst-kix_m9hl1rm2thn6-6{list-style-type:none}ul.lst-kix_m9hl1rm2thn6-7{list-style-type:none}.lst-kix_tbt3fp5mpfdn-4>li:before{content:"\0025cb   "}ul.lst-kix_m9hl1rm2thn6-8{list-style-type:none}.lst-kix_tbt3fp5mpfdn-5>li:before{content:"\0025a0   "}.lst-kix_i6uk1nmxf1v5-4>li{counter-increment:lst-ctn-kix_i6uk1nmxf1v5-4}.lst-kix_q6e5llwbj00b-7>li:before{content:"\0025cb   "}.lst-kix_tbt3fp5mpfdn-8>li:before{content:"\0025a0   "}.lst-kix_c7i1dok25hqo-6>li:before{content:"\0025cf   "}.lst-kix_i6uk1nmxf1v5-0>li:before{content:"" counter(lst-ctn-kix_i6uk1nmxf1v5-0,decimal) ". "}.lst-kix_c7i1dok25hqo-5>li:before{content:"\0025a0   "}.lst-kix_1emiwc70v2fc-1>li:before{content:"\0025cb   "}.lst-kix_i6uk1nmxf1v5-7>li:before{content:"" counter(lst-ctn-kix_i6uk1nmxf1v5-7,lower-latin) ". "}.lst-kix_i6uk1nmxf1v5-8>li:before{content:"" counter(lst-ctn-kix_i6uk1nmxf1v5-8,lower-roman) ". "}.lst-kix_c7i1dok25hqo-1>li:before{content:"\0025cb   "}.lst-kix_z68r28hjx3of-1>li:before{content:"\0025cb   "}.lst-kix_z68r28hjx3of-2>li:before{content:"\0025a0   "}.lst-kix_t8id0ej4c58t-3>li:before{content:"\0025cf   "}.lst-kix_i6uk1nmxf1v5-3>li:before{content:"" counter(lst-ctn-kix_i6uk1nmxf1v5-3,decimal) ". "}.lst-kix_c7i1dok25hqo-2>li:before{content:"\0025a0   "}.lst-kix_i6uk1nmxf1v5-4>li:before{content:"" counter(lst-ctn-kix_i6uk1nmxf1v5-4,lower-latin) ". "}.lst-kix_t8id0ej4c58t-0>li:before{content:"\0025cf   "}ul.lst-kix_oqjom6a2yix0-8{list-style-type:none}ul.lst-kix_cei76fufwbsa-0{list-style-type:none}ul.lst-kix_cei76fufwbsa-1{list-style-type:none}ul.lst-kix_cei76fufwbsa-2{list-style-type:none}ul.lst-kix_cei76fufwbsa-3{list-style-type:none}.lst-kix_i6uk1nmxf1v5-7>li{counter-increment:lst-ctn-kix_i6uk1nmxf1v5-7}ul.lst-kix_cei76fufwbsa-4{list-style-type:none}.lst-kix_oc3r6ynugb1-1>li:before{content:"\0025cb   "}.lst-kix_oc3r6ynugb1-5>li:before{content:"\0025a0   "}ul.lst-kix_cei76fufwbsa-5{list-style-type:none}ul.lst-kix_cei76fufwbsa-6{list-style-type:none}.lst-kix_mvx7bf7jy6x0-8>li:before{content:"\0025a0   "}.lst-kix_l532cjf69trz-8>li:before{content:"\0025a0   "}ul.lst-kix_cei76fufwbsa-7{list-style-type:none}ul.lst-kix_oqjom6a2yix0-0{list-style-type:none}ul.lst-kix_cei76fufwbsa-8{list-style-type:none}ul.lst-kix_oqjom6a2yix0-1{list-style-type:none}ul.lst-kix_oqjom6a2yix0-2{list-style-type:none}ul.lst-kix_oqjom6a2yix0-3{list-style-type:none}.lst-kix_l532cjf69trz-4>li:before{content:"\0025cb   "}ul.lst-kix_oqjom6a2yix0-4{list-style-type:none}ul.lst-kix_oqjom6a2yix0-5{list-style-type:none}ul.lst-kix_oqjom6a2yix0-6{list-style-type:none}ul.lst-kix_oqjom6a2yix0-7{list-style-type:none}.lst-kix_l532cjf69trz-0>li:before{content:"\0025cf   "}.lst-kix_oqjom6a2yix0-7>li:before{content:"\0025cb   "}ol.lst-kix_i6uk1nmxf1v5-2.start{counter-reset:lst-ctn-kix_i6uk1nmxf1v5-2 0}ul.lst-kix_q6e5llwbj00b-8{list-style-type:none}ul.lst-kix_q6e5llwbj00b-7{list-style-type:none}ul.lst-kix_q6e5llwbj00b-6{list-style-type:none}ul.lst-kix_q6e5llwbj00b-5{list-style-type:none}ul.lst-kix_q6e5llwbj00b-4{list-style-type:none}ul.lst-kix_q6e5llwbj00b-3{list-style-type:none}ul.lst-kix_q6e5llwbj00b-2{list-style-type:none}ul.lst-kix_q6e5llwbj00b-1{list-style-type:none}ul.lst-kix_q6e5llwbj00b-0{list-style-type:none}.lst-kix_m9hl1rm2thn6-8>li:before{content:"\0025a0   "}ul.lst-kix_n78w9728jq9m-4{list-style-type:none}ul.lst-kix_n78w9728jq9m-5{list-style-type:none}ol.lst-kix_i6uk1nmxf1v5-1.start{counter-reset:lst-ctn-kix_i6uk1nmxf1v5-1 0}ul.lst-kix_n78w9728jq9m-2{list-style-type:none}ul.lst-kix_n78w9728jq9m-3{list-style-type:none}ul.lst-kix_n78w9728jq9m-8{list-style-type:none}ul.lst-kix_n78w9728jq9m-6{list-style-type:none}ul.lst-kix_n78w9728jq9m-7{list-style-type:none}.lst-kix_oqjom6a2yix0-3>li:before{content:"\0025cf   "}ul.lst-kix_n78w9728jq9m-0{list-style-type:none}ul.lst-kix_n78w9728jq9m-1{list-style-type:none}.lst-kix_mvx7bf7jy6x0-0>li:before{content:"\0025cf   "}ol.lst-kix_i6uk1nmxf1v5-0.start{counter-reset:lst-ctn-kix_i6uk1nmxf1v5-0 0}.lst-kix_m9hl1rm2thn6-0>li:before{content:"\0025cf   "}.lst-kix_mvx7bf7jy6x0-4>li:before{content:"\0025cb   "}.lst-kix_i6uk1nmxf1v5-2>li{counter-increment:lst-ctn-kix_i6uk1nmxf1v5-2}.lst-kix_m9hl1rm2thn6-4>li:before{content:"\0025cb   "}ol{margin:0;padding:0}table td,table th{padding:0}.c29{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#808080;border-top-width:0pt;border-right-width:0pt;border-left-color:#808080;vertical-align:bottom;border-right-color:#808080;border-left-width:0pt;border-top-style:solid;border-left-style:solid;border-bottom-width:0pt;width:58.5pt;border-top-color:#808080;border-bottom-style:solid}.c57{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#808080;border-top-width:0pt;border-right-width:0pt;border-left-color:#808080;vertical-align:bottom;border-right-color:#808080;border-left-width:0pt;border-top-style:solid;border-left-style:solid;border-bottom-width:0pt;width:57.8pt;border-top-color:#808080;border-bottom-style:solid}.c43{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#808080;border-top-width:0pt;border-right-width:0pt;border-left-color:#808080;vertical-align:bottom;border-right-color:#808080;border-left-width:0pt;border-top-style:solid;border-left-style:solid;border-bottom-width:0pt;width:112.5pt;border-top-color:#808080;border-bottom-style:solid}.c52{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#808080;border-top-width:0pt;border-right-width:0pt;border-left-color:#808080;vertical-align:bottom;border-right-color:#808080;border-left-width:0pt;border-top-style:solid;border-left-style:solid;border-bottom-width:0pt;width:46.2pt;border-top-color:#808080;border-bottom-style:solid}.c35{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#808080;border-top-width:0pt;border-right-width:0pt;border-left-color:#808080;vertical-align:bottom;border-right-color:#808080;border-left-width:0pt;border-top-style:solid;border-left-style:solid;border-bottom-width:0pt;width:51.4pt;border-top-color:#808080;border-bottom-style:solid}.c40{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#808080;border-top-width:0pt;border-right-width:0pt;border-left-color:#808080;vertical-align:bottom;border-right-color:#808080;border-left-width:0pt;border-top-style:solid;border-left-style:solid;border-bottom-width:0pt;width:110.7pt;border-top-color:#808080;border-bottom-style:solid}.c46{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#808080;border-top-width:0pt;border-right-width:0pt;border-left-color:#808080;vertical-align:bottom;border-right-color:#808080;border-left-width:0pt;border-top-style:solid;border-left-style:solid;border-bottom-width:0pt;width:106pt;border-top-color:#808080;border-bottom-style:solid}.c47{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#808080;border-top-width:0pt;border-right-width:0pt;border-left-color:#808080;vertical-align:bottom;border-right-color:#808080;border-left-width:0pt;border-top-style:solid;border-left-style:solid;border-bottom-width:0pt;width:17.9pt;border-top-color:#808080;border-bottom-style:solid}.c49{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#808080;border-top-width:0pt;border-right-width:0pt;border-left-color:#808080;vertical-align:bottom;border-right-color:#808080;border-left-width:0pt;border-top-style:solid;border-left-style:solid;border-bottom-width:0pt;width:60.6pt;border-top-color:#808080;border-bottom-style:solid}.c26{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#808080;border-top-width:0pt;border-right-width:0pt;border-left-color:#808080;vertical-align:bottom;border-right-color:#808080;border-left-width:0pt;border-top-style:solid;border-left-style:solid;border-bottom-width:0pt;width:115.8pt;border-top-color:#808080;border-bottom-style:solid}.c39{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#808080;border-top-width:0pt;border-right-width:0pt;border-left-color:#808080;vertical-align:bottom;border-right-color:#808080;border-left-width:0pt;border-top-style:solid;border-left-style:solid;border-bottom-width:0pt;width:46.8pt;border-top-color:#808080;border-bottom-style:solid}.c8{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#808080;border-top-width:0pt;border-right-width:0pt;border-left-color:#808080;vertical-align:bottom;border-right-color:#808080;border-left-width:0pt;border-top-style:solid;border-left-style:solid;border-bottom-width:0pt;width:59.1pt;border-top-color:#808080;border-bottom-style:solid}.c45{margin-left:18pt;padding-top:3pt;padding-bottom:0pt;line-height:1.0;orphans:2;widows:2;text-align:left}.c2{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c13{padding-top:20pt;padding-bottom:10pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:justify}.c42{padding-top:18pt;padding-bottom:10pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:justify}.c36{margin-left:36pt;padding-top:3pt;padding-bottom:4pt;line-height:1.0;orphans:2;widows:2;text-align:left}.c28{color:#434343;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:14pt;font-family:"Arial";font-style:normal}.c4{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:8pt;font-family:"Roboto Mono";font-style:normal}.c6{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:8pt;font-family:"Arial";font-style:normal}.c31{margin-left:36pt;padding-top:3pt;padding-bottom:0pt;line-height:1.0;orphans:2;widows:2;text-align:left}.c44{padding-top:16pt;padding-bottom:10pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:justify}.c1{-webkit-text-decoration-skip:none;color:#1155cc;font-weight:400;text-decoration:underline;text-decoration-skip-ink:none;font-size:8pt;font-family:"Roboto Mono"}.c14{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c12{padding-top:0pt;padding-bottom:10pt;line-height:1.15;orphans:2;widows:2;text-align:justify}.c18{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:justify}.c34{color:#000000;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c33{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:right}.c11{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-family:"Arial";font-style:normal}.c9{padding-top:12pt;padding-bottom:0pt;line-height:0.06818181818181818;orphans:2;widows:2;text-align:left}.c7{background-color:#ffffff;font-size:8pt;font-family:"Roboto Mono";color:#333333;font-weight:400}.c3{text-decoration-skip-ink:none;font-size:10pt;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.c19{font-size:8pt;font-family:"Roboto Mono";color:#ff0000;font-weight:400}.c16{font-size:8pt;font-family:"Roboto Mono";color:#0000ff;font-weight:400}.c65{border-spacing:0;border-collapse:collapse;margin-right:auto}.c64{padding-top:4pt;padding-bottom:0pt;line-height:1.0;text-align:left}.c20{font-size:8pt;font-family:"Roboto Mono";color:#a31515;font-weight:400}.c15{background-color:#ffffff;font-size:8pt;font-family:"Roboto Mono";font-weight:400}.c55{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.c5{padding-top:0pt;padding-bottom:10pt;line-height:1.15;text-align:left}.c38{text-decoration:none;vertical-align:baseline;font-style:normal}.c60{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;text-decoration:underline}.c41{color:#434343;font-weight:400;font-family:"Arial"}.c30{font-size:8pt;font-family:"Roboto Mono";font-weight:400}.c61{orphans:2;widows:2}.c58{color:#000000;font-family:"Arial"}.c23{margin-left:36pt;padding-left:0pt}.c37{margin-left:72pt;padding-left:0pt}.c48{max-width:451.4pt;padding:72pt 72pt 72pt 72pt}.c0{padding:0;margin:0}.c21{color:inherit;text-decoration:inherit}.c54{color:#ffffff;font-size:8pt}.c62{height:16pt}.c66{font-size:8pt}.c50{margin-left:36pt}.c24{height:11pt}.c51{background-color:#000000}.c59{color:#008080}.c56{font-size:16pt}.c63{height:25pt}.c53{font-size:20pt}.c17{background-color:#ffffff}.c22{font-style:italic}.c27{font-weight:700}.c25{color:#dd1144}.c10{font-size:10pt}.c32{height:28pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c17 c48"><h1 class="c13" id="h.tfoh2k5oxhkh"><span class="c11 c53">Manual de LUNR</span></h1><p class="c12"><span class="c2">Javier Portal Mart&iacute;nez</span></p><p class="c12"><span class="c2">Versi&oacute;n: 1.0</span></p><p class="c61 c64"><span class="c27 c34"><a class="c21" href="#h.tfoh2k5oxhkh">Manual de LUNR</a></span><span class="c34 c27">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c34 c27"><a class="c21" href="#h.tfoh2k5oxhkh">0</a></span></p><p class="c45"><span class="c2"><a class="c21" href="#h.91kc88jbg5zw">Introducci&oacute;n</a></span><span class="c2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c2"><a class="c21" href="#h.91kc88jbg5zw">1</a></span></p><p class="c45"><span class="c2"><a class="c21" href="#h.o0y634vldk0m">Un ejemplo b&aacute;sico</a></span><span class="c2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c2"><a class="c21" href="#h.o0y634vldk0m">2</a></span></p><p class="c31"><span class="c2"><a class="c21" href="#h.45y511drkypx">Preparando el origen de datos</a></span><span class="c2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c2"><a class="c21" href="#h.45y511drkypx">3</a></span></p><p class="c31"><span class="c2"><a class="c21" href="#h.ko95j29xmedd">P&aacute;gina de b&uacute;squeda</a></span><span class="c2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c2"><a class="c21" href="#h.ko95j29xmedd">5</a></span></p><p class="c31"><span class="c2"><a class="c21" href="#h.oq5agwmpf1zq">An&aacute;lisis de los resultados de la b&uacute;squeda</a></span><span class="c2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c2"><a class="c21" href="#h.oq5agwmpf1zq">9</a></span></p><p class="c45"><span><a class="c21" href="#h.5jlwyzsrplfw">Tuning y gram&aacute;tica del castellano</a></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span><a class="c21" href="#h.5jlwyzsrplfw">13</a></span></p><p class="c31"><span class="c2"><a class="c21" href="#h.dk7euelpu8iv">Asignando relevancia a los campos seg&uacute;n su importancia</a></span><span class="c2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c2"><a class="c21" href="#h.dk7euelpu8iv">13</a></span></p><p class="c31"><span class="c2"><a class="c21" href="#h.llj3hkka8moo">Algoritmo de b&uacute;squeda de lunr</a></span><span class="c2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c2"><a class="c21" href="#h.llj3hkka8moo">14</a></span></p><p class="c31"><span class="c2"><a class="c21" href="#h.l983wsuwtlzl">Usando la gram&aacute;tica del castellano</a></span><span class="c2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c2"><a class="c21" href="#h.l983wsuwtlzl">14</a></span></p><p class="c31"><span class="c2"><a class="c21" href="#h.4nii7yula5ij">An&aacute;lisis de los resultados de la b&uacute;squeda</a></span><span class="c2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c2"><a class="c21" href="#h.4nii7yula5ij">16</a></span></p><p class="c31"><span class="c2"><a class="c21" href="#h.ffydmksid8yj">Filtros y c&oacute;digos postales</a></span><span class="c2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c2"><a class="c21" href="#h.ffydmksid8yj">16</a></span></p><p class="c45"><span class="c2"><a class="c21" href="#h.264tgsdup7s9">B&uacute;squeda avanzada</a></span><span class="c2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c2"><a class="c21" href="#h.264tgsdup7s9">22</a></span></p><p class="c31"><span class="c2"><a class="c21" href="#h.9enlc5ihlmvu">B&uacute;squedas difusas</a></span><span class="c2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c2"><a class="c21" href="#h.9enlc5ihlmvu">22</a></span></p><p class="c31"><span class="c2"><a class="c21" href="#h.n9diwfpo4my5">Construcci&oacute;n de Query program&aacute;ticamente</a></span><span class="c2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c2"><a class="c21" href="#h.n9diwfpo4my5">24</a></span></p><p class="c31"><span class="c2"><a class="c21" href="#h.drfszcjkeyxv">Paginaci&oacute;n</a></span><span class="c2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c2"><a class="c21" href="#h.drfszcjkeyxv">27</a></span></p><p class="c31"><span class="c2"><a class="c21" href="#h.ccfgqxr0zw5c">Trabajando con fechas</a></span><span class="c2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c2"><a class="c21" href="#h.ccfgqxr0zw5c">29</a></span></p><p class="c31"><span class="c2"><a class="c21" href="#h.k30939new0es">Documentos destacados</a></span><span class="c2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c2"><a class="c21" href="#h.k30939new0es">30</a></span></p><p class="c31"><span class="c2"><a class="c21" href="#h.lsek4mokcmi9">Serializaci&oacute;n</a></span><span class="c2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c2"><a class="c21" href="#h.lsek4mokcmi9">32</a></span></p><p class="c31"><span><a class="c21" href="#h.dja0qib5bhv7">Los filtros no funcionan</a></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span><a class="c21" href="#h.dja0qib5bhv7">33</a></span></p><p class="c45"><span><a class="c21" href="#h.2tl60doo6kvr">Consideraciones finales</a></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span><a class="c21" href="#h.2tl60doo6kvr">35</a></span></p><p class="c31"><span class="c2"><a class="c21" href="#h.yawyqdsgfzvx">Mejoras en la librer&iacute;a</a></span><span class="c2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c2"><a class="c21" href="#h.yawyqdsgfzvx">35</a></span></p><p class="c36"><span class="c2"><a class="c21" href="#h.clccx59huqch">Otras librer&iacute;as</a></span><span class="c2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c2"><a class="c21" href="#h.clccx59huqch">35</a></span></p><p class="c5 c61 c24"><span class="c2"></span></p><hr style="page-break-before:always;display:none;"><p class="c12 c24"><span class="c2"></span></p><h2 class="c42" id="h.91kc88jbg5zw"><span class="c11 c56">Introducci&oacute;n</span></h2><p class="c12"><span class="c2">En este documento vamos a tratar de implementar un buscador usando la librer&iacute;a lunr.js que es un motor de b&uacute;squeda construido totalmente en javascript y que por tanto funciona s&oacute;lo en la capa cliente sin necesitad de un servidor ni conexi&oacute;n tras la carga de la p&aacute;gina.</span></p><p class="c12"><span class="c2">Todo el c&oacute;digo est&aacute; implementado con la versi&oacute;n 2.3.8 de la librer&iacute;a.</span></p><p class="c12"><span class="c2">Lunr implementa algunas de las funcionalidades de Solr, uno de los motores de b&uacute;squeda m&aacute;s utilizado del lado del servidor.</span></p><p class="c12"><span class="c2">El funcionamiento b&aacute;sico de esta librer&iacute;a consiste en parsear los textos de un conjunto de documentos que le debemos proporcionar en formato JSON con los que crea un &iacute;ndice inverso que proporciona b&uacute;squedas muy r&aacute;pidas. Tambi&eacute;n proporciona mecanismos para modificar la relevancia de campos y documentos tanto en tiempo de indexaci&oacute;n como de consulta.</span></p><p class="c12"><span class="c2">Se denomina documento en este contexto a cada uno de los objetos estructurados con atributos de tipo texto que a&ntilde;adimos al &iacute;ndice de Lunr. Un documento habitualmente puede estar estructurado en los siguientes atributos: ref o ID, t&iacute;tulo, cuerpo, enlace, etc.</span></p><p class="c12"><span class="c2">Este tipo de motores de b&uacute;squeda suelen implementar algunas o todas de las siguientes funcionalidades:</span></p><ul class="c0 lst-kix_5r6xq1gg8hbq-0 start"><li class="c12 c23"><span class="c2">B&uacute;squeda muy r&aacute;pida por texto libre y por varios campos simultaneamente.</span></li><li class="c12 c23"><span class="c2">Buena ponderaci&oacute;n de los documentos m&aacute;s similares a la b&uacute;squeda.</span></li><li class="c12 c23"><span class="c2">B&uacute;squedas neutrales con respecto a may&uacute;sculas, min&uacute;sculas, tildes, etc.</span></li><li class="c12 c23"><span class="c2">Stemming. C&aacute;lculo de las ra&iacute;ces de los textos seg&uacute;n el idioma que permite encontrar palabras derivadas de las palabras buscadas.</span></li><li class="c12 c23"><span class="c2">Stop words. Posibilidad de eliminar las palabras que no contienen sem&aacute;ntica.</span></li><li class="c12 c23"><span class="c2">B&uacute;squedas difusas. Posibilidad de encontrar resultados aproximados aunque se hayan introducidos palabras en la b&uacute;squeda con errores ortogr&aacute;ficos.</span></li></ul><p class="c12 c24"><span class="c2"></span></p><p class="c12 c24"><span class="c2"></span></p><p class="c12 c24"><span class="c2"></span></p><hr style="page-break-before:always;display:none;"><h2 class="c42 c62" id="h.9m5rb0kwmnsu"><span class="c11 c56"></span></h2><h2 class="c42" id="h.o0y634vldk0m"><span class="c11 c56">Un ejemplo b&aacute;sico</span></h2><p class="c12"><span class="c2">Vamos a partir de un excel como origen de datos, transformarlo en JSON e implementar un ejemplo b&aacute;sica de p&aacute;gina de b&uacute;squeda libre y un filtro que nos permita filtrar por municipios de la Comunidad de Madrid.</span></p><p class="c12"><span class="c2">En este primer ejemplo no vamos a usar gram&aacute;ticas de lenguajes espec&iacute;ficos, en nuestro caso el castellano, sino s&oacute;lo las funcionalidades que proporciona por defecto la librer&iacute;a lunr,js</span></p><p class="c12"><span class="c2">Todos los datos se cargar&aacute;n en local, en el navegador. Los datos los cargaremos inicialmente en un JSON. Este array en formato JSON lo utilizaremos tanto para inicializar el &iacute;ndice de b&uacute;squeda tanto como para luego pintar los resultados. El &iacute;ndice (idx en la figura) lo utilizaremos para lanzar las b&uacute;squedas.</span></p><p class="c12 c24"><span class="c2"></span></p><p class="c12"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 561.00px; height: 281.00px;"><img alt="" src="images/image4.png" style="width: 561.00px; height: 281.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c12"><span class="c2">Lunr no almacena los campos originales en el &iacute;ndice, luego, si queremos pintarlos tenemos que tenerlos almacenados en una estructura en nuestra p&aacute;gina (que puede ser el propio JSON si es que el id o ref de cada registro es tambi&eacute;n el orden del array)</span></p><p class="c12"><span class="c2">La conversaci&oacute;n sobre la idoneidad de que Lunr (al igual que hace Solr) almacene el campo original y que el comportamiento pueda ser controlado por un atributo del campo denominado stored se puede encontrar aqu&iacute;:</span></p><p class="c12"><span class="c55"><a class="c21" href="https://www.google.com/url?q=https://github.com/olivernn/lunr.js/issues/88&amp;sa=D&amp;ust=1596099093963000&amp;usg=AOvVaw0KfRvxdgBBwuu8RR3DwdTW">https://github.com/olivernn/lunr.js/issues/88</a></span><span class="c2">&nbsp;</span></p><p class="c12 c24"><span class="c2"></span></p><h3 class="c44" id="h.45y511drkypx"><span class="c28">Preparando el origen de datos</span></h3><p class="c5 c61"><span class="c2">Supongamos que partimos de una serie de centros de la Comunidad de Madrid en formato excel:</span></p><a id="t.8d53a80a182e702d5253e09cacd3818a55f8a995"></a><a id="t.0"></a><table class="c65"><tbody><tr class="c32"><td class="c46 c51" colspan="1" rowspan="1"><p class="c5"><span class="c54">NOMBRE</span></p></td><td class="c40 c51" colspan="1" rowspan="1"><p class="c5"><span class="c54">DOMICILIO</span></p></td><td class="c57 c51" colspan="1" rowspan="1"><p class="c5"><span class="c54">C&Oacute;DIGO POSTAL</span></p></td><td class="c8 c51" colspan="1" rowspan="1"><p class="c5"><span class="c54">PROVINCIA</span></p></td><td class="c8 c51" colspan="1" rowspan="1"><p class="c5"><span class="c54">LOCALIDAD</span></p></td><td class="c29 c51" colspan="1" rowspan="1"><p class="c5"><span class="c54">TEL&Eacute;FONO</span></p></td></tr><tr class="c63"><td class="c46" colspan="1" rowspan="1"><p class="c5"><span class="c6">Biblioteca P&uacute;blica Hortaleza</span></p></td><td class="c40" colspan="1" rowspan="1"><p class="c5"><span class="c6">Calle Abertura, s/n</span></p></td><td class="c57" colspan="1" rowspan="1"><p class="c5"><span class="c6">28033</span></p></td><td class="c8" colspan="1" rowspan="1"><p class="c5"><span class="c6">Madrid</span></p></td><td class="c8" colspan="1" rowspan="1"><p class="c5"><span class="c6">Madrid</span></p></td><td class="c29" colspan="1" rowspan="1"><p class="c5"><span class="c6">91 763 32 84</span></p></td></tr><tr class="c63"><td class="c46" colspan="1" rowspan="1"><p class="c5"><span class="c6">Biblioteca P&uacute;blica Moratalaz</span></p></td><td class="c40" colspan="1" rowspan="1"><p class="c5"><span class="c6">Calle Corregidor Alonso de Tobar, 5</span></p></td><td class="c57" colspan="1" rowspan="1"><p class="c5"><span class="c6">28030</span></p></td><td class="c8" colspan="1" rowspan="1"><p class="c5"><span class="c6">Madrid</span></p></td><td class="c8" colspan="1" rowspan="1"><p class="c5"><span class="c6">Madrid</span></p></td><td class="c29" colspan="1" rowspan="1"><p class="c5"><span class="c6">91 439 46 88</span></p></td></tr><tr class="c32"><td class="c46" colspan="1" rowspan="1"><p class="c5"><span class="c6">Biblioteca P&uacute;blica Ruiz Egea (Chamber&iacute;)</span></p></td><td class="c40" colspan="1" rowspan="1"><p class="c5"><span class="c6">Calle de Raimundo Fern&aacute;ndez Villaverde, 6</span></p></td><td class="c57" colspan="1" rowspan="1"><p class="c5"><span class="c6">28003</span></p></td><td class="c8" colspan="1" rowspan="1"><p class="c5"><span class="c6">Madrid</span></p></td><td class="c8" colspan="1" rowspan="1"><p class="c5"><span class="c6">MADRID</span></p></td><td class="c29" colspan="1" rowspan="1"><p class="c5"><span class="c6">91 534 90 29</span></p></td></tr><tr class="c32"><td class="c46" colspan="1" rowspan="1"><p class="c5"><span class="c6">Biblioteca P&uacute;blica Mar&iacute;a Moliner (Villaverde)</span></p></td><td class="c40" colspan="1" rowspan="1"><p class="c5"><span class="c6">Calle de Villalonso, 14</span></p></td><td class="c57" colspan="1" rowspan="1"><p class="c5"><span class="c6">28021</span></p></td><td class="c8" colspan="1" rowspan="1"><p class="c5"><span class="c6">Madrid</span></p></td><td class="c8" colspan="1" rowspan="1"><p class="c5"><span class="c6">MADRID</span></p></td><td class="c29" colspan="1" rowspan="1"><p class="c5"><span class="c6">917 23 01 94</span></p></td></tr><tr class="c32"><td class="c46" colspan="1" rowspan="1"><p class="c5"><span class="c6">Residencia y centro de d&iacute;a Parque Coimbra</span></p></td><td class="c40" colspan="1" rowspan="1"><p class="c5"><span class="c6">Avda. de los Sauces, 55</span></p></td><td class="c57" colspan="1" rowspan="1"><p class="c5"><span class="c6">28935</span></p></td><td class="c8" colspan="1" rowspan="1"><p class="c5"><span class="c6">Madrid</span></p></td><td class="c8" colspan="1" rowspan="1"><p class="c5"><span class="c6">M&oacute;stoles</span></p></td><td class="c29" colspan="1" rowspan="1"><p class="c5"><span class="c6">91 646 18 93</span></p></td></tr></tbody></table><p class="c12"><span class="c2">Antes de nada, es necesario preparar la excel de entrada para que genere un json adecuado realizando las siguientes tareas:</span></p><ul class="c0 lst-kix_l532cjf69trz-0 start"><li class="c12 c23"><span class="c2">Presentaci&oacute;n de los campos. Hay que tener en cuenta que tal y como est&eacute;n los campos en la excel as&iacute; se ver&aacute;n en la p&aacute;gina por lo que conviene realizar las adaptaciones necesarias. Por ejemplo, conviene adaptar los campos que est&eacute;n en may&uacute;sculas, los campos que no tengan valores homog&eacute;neos, corregir errores ortogr&aacute;ficos, etc.</span></li><li class="c12 c23"><span class="c2">A&ntilde;adir una columna de clave. Como en este primer ejemplo vamos a usar el array json tambi&eacute;n para pintar los campos y lunr nos va a devolver una lista de IDs como resultados de la b&uacute;squeda, conviene que los ID de los registro sea su posici&oacute;n en el array json. Por tanto, a&ntilde;adiremos una columna al excel de un secuencial comenzando en cero (los arrays en javascript empiezan en cero).</span></li><li class="c12 c23"><span class="c2">Adaptaci&oacute;n de las cabeceras. Por comodidad, eliminaremos de las columnas las tildes, fusionaremos en una sola palabra si el t&iacute;tulo de la columna se compone de m&aacute;s de una, pasaremos a min&uacute;sculas.</span></li><li class="c12 c23"><span>Campos que pueden dar problemas en el tokenizado. Lunr intentar&aacute; descomponer en palabras los campos por lo que hay que analizar nuestro origen de datos para detectar posibles problemas. En el excel del ejemplo el campo Tel&eacute;fono dar&aacute; problemas porque los n&uacute;meros est&aacute;n separados por espacios, con lo que solr interpretar&aacute; que el n&uacute;mero de tel&eacute;fono </span><span class="c66">91 646 18 93</span><span class="c2">&nbsp;en realidad se descompone en 91, 646, 18 y 93. Algo similar pasar&aacute; si uno de las columnas contiene textos con palabras separadas por guiones, barras y cualquier car&aacute;cter que lunr utilice para tokenizar.</span></li><li class="c12 c23"><span class="c2">Valores m&uacute;ltiples. Si una de las columnas puede tener varios valores, habr&aacute; que tratar ese campo como un array en el json. M&aacute;s adelante veremos que esto debemos aplicarlo a cualquier campo sobre el que queramos aplicar filtros o facetados.</span></li></ul><p class="c12"><span class="c2">Una vez realizadas estas operaciones la excel queda de este modo.</span></p><p class="c5 c61 c24"><span class="c2"></span></p><a id="t.5623241dca74b94e2ae7d4bc428aeab1ff64035d"></a><a id="t.1"></a><table class="c65"><tbody><tr class="c63"><td class="c47 c51" colspan="1" rowspan="1"><p class="c5"><span class="c54">id</span></p></td><td class="c43 c51" colspan="1" rowspan="1"><p class="c5"><span class="c54">nombre</span></p></td><td class="c26 c51" colspan="1" rowspan="1"><p class="c5"><span class="c54">domicilio</span></p></td><td class="c49 c51" colspan="1" rowspan="1"><p class="c5"><span class="c54">codigo_postal</span></p></td><td class="c39 c51" colspan="1" rowspan="1"><p class="c5"><span class="c54">provincia</span></p></td><td class="c52 c51" colspan="1" rowspan="1"><p class="c5"><span class="c54">localidad</span></p></td><td class="c35 c51" colspan="1" rowspan="1"><p class="c5"><span class="c54">telefono</span></p></td></tr><tr class="c63"><td class="c47" colspan="1" rowspan="1"><p class="c5"><span class="c6">0</span></p></td><td class="c43" colspan="1" rowspan="1"><p class="c5"><span class="c6">Biblioteca P&uacute;blica Hortaleza</span></p></td><td class="c26" colspan="1" rowspan="1"><p class="c5"><span class="c6">Calle Abertura, s/n</span></p></td><td class="c49" colspan="1" rowspan="1"><p class="c5"><span class="c6">28033</span></p></td><td class="c39" colspan="1" rowspan="1"><p class="c5"><span class="c6">Madrid</span></p></td><td class="c52" colspan="1" rowspan="1"><p class="c5"><span class="c6">Madrid</span></p></td><td class="c35" colspan="1" rowspan="1"><p class="c5"><span class="c6">917633284</span></p></td></tr><tr class="c63"><td class="c47" colspan="1" rowspan="1"><p class="c5"><span class="c6">1</span></p></td><td class="c43" colspan="1" rowspan="1"><p class="c5"><span class="c6">Biblioteca P&uacute;blica Moratalaz</span></p></td><td class="c26" colspan="1" rowspan="1"><p class="c5"><span class="c6">Calle Corregidor Alonso de Tobar, 5</span></p></td><td class="c49" colspan="1" rowspan="1"><p class="c5"><span class="c6">28030</span></p></td><td class="c39" colspan="1" rowspan="1"><p class="c5"><span class="c6">Madrid</span></p></td><td class="c52" colspan="1" rowspan="1"><p class="c5"><span class="c6">Madrid</span></p></td><td class="c35" colspan="1" rowspan="1"><p class="c5"><span class="c6">914394688</span></p></td></tr><tr class="c32"><td class="c47" colspan="1" rowspan="1"><p class="c5"><span class="c6">2</span></p></td><td class="c43" colspan="1" rowspan="1"><p class="c5"><span class="c6">Biblioteca P&uacute;blica Ruiz Egea (Chamber&iacute;)</span></p></td><td class="c26" colspan="1" rowspan="1"><p class="c5"><span class="c6">Calle de Raimundo Fern&aacute;ndez Villaverde, 6</span></p></td><td class="c49" colspan="1" rowspan="1"><p class="c5"><span class="c6">28003</span></p></td><td class="c39" colspan="1" rowspan="1"><p class="c5"><span class="c6">Madrid</span></p></td><td class="c52" colspan="1" rowspan="1"><p class="c5"><span class="c6">Madrid</span></p></td><td class="c35" colspan="1" rowspan="1"><p class="c5"><span class="c6">915349029</span></p></td></tr><tr class="c32"><td class="c47" colspan="1" rowspan="1"><p class="c5"><span class="c6">3</span></p></td><td class="c43" colspan="1" rowspan="1"><p class="c5"><span class="c6">Biblioteca P&uacute;blica Mar&iacute;a Moliner (Villaverde)</span></p></td><td class="c26" colspan="1" rowspan="1"><p class="c5"><span class="c6">Calle de Villalonso, 14</span></p></td><td class="c49" colspan="1" rowspan="1"><p class="c5"><span class="c6">28021</span></p></td><td class="c39" colspan="1" rowspan="1"><p class="c5"><span class="c6">Madrid</span></p></td><td class="c52" colspan="1" rowspan="1"><p class="c5"><span class="c6">Madrid</span></p></td><td class="c35" colspan="1" rowspan="1"><p class="c5"><span class="c6">917230194</span></p></td></tr><tr class="c32"><td class="c47" colspan="1" rowspan="1"><p class="c5"><span class="c6">4</span></p></td><td class="c43" colspan="1" rowspan="1"><p class="c5"><span class="c6">Residencia y centro de d&iacute;a Parque Coimbra</span></p></td><td class="c26" colspan="1" rowspan="1"><p class="c5"><span class="c6">Avda. de los Sauces, 55</span></p></td><td class="c49" colspan="1" rowspan="1"><p class="c5"><span class="c6">28935</span></p></td><td class="c39" colspan="1" rowspan="1"><p class="c5"><span class="c6">Madrid</span></p></td><td class="c52" colspan="1" rowspan="1"><p class="c5"><span class="c6">M&oacute;stoles</span></p></td><td class="c35" colspan="1" rowspan="1"><p class="c5"><span class="c6">916461893</span></p></td></tr></tbody></table><p class="c12 c24"><span class="c6"></span></p><p class="c12"><span class="c11 c10">A continuaci&oacute;n, debemos generar un json a partir del excel. Una b&uacute;squeda en google de &ldquo;generates json from excel&rdquo; nos ofrecer&aacute; una serie utilidades online que permiten transformar CSV en JSON. Obtendremos algo similar a esto:</span></p><p class="c18"><span class="c6">[</span></p><p class="c18"><span class="c6">&nbsp;{</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;id&quot;: 0,</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;nombre&quot;: &quot;Biblioteca P&uacute;blica Hortaleza&quot;,</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;domicilio&quot;: &quot;Calle Abertura, s/n&quot;,</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;codigo_postal&quot;: 28033,</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;provincia&quot;: &quot;Madrid&quot;,</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;localidad&quot;: &quot;Madrid&quot;,</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;telefono&quot;: 917633284</span></p><p class="c18"><span class="c6">&nbsp;},</span></p><p class="c18"><span class="c6">&nbsp;{</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;id&quot;: 1,</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;nombre&quot;: &quot;Biblioteca P&uacute;blica Moratalaz&quot;,</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;domicilio&quot;: &quot;Calle Corregidor Alonso de Tobar, 5&quot;,</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;codigo_postal&quot;: 28030,</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;provincia&quot;: &quot;Madrid&quot;,</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;localidad&quot;: &quot;Madrid&quot;,</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;telefono&quot;: 914394688</span></p><p class="c18"><span class="c6">&nbsp;},</span></p><p class="c18"><span class="c6">&nbsp;{</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;id&quot;: 2,</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;nombre&quot;: &quot;Biblioteca P&uacute;blica Ruiz Egea (Chamber&iacute;)&quot;,</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;domicilio&quot;: &quot;Calle de Raimundo Fern&aacute;ndez Villaverde, 6&quot;,</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;codigo_postal&quot;: 28003,</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;provincia&quot;: &quot;Madrid&quot;,</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;localidad&quot;: &quot;Madrid&quot;,</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;telefono&quot;: 915349029</span></p><p class="c18"><span class="c6">&nbsp;},</span></p><p class="c18"><span class="c6">&nbsp;{</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;id&quot;: 3,</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;nombre&quot;: &quot;Biblioteca P&uacute;blica Mar&iacute;a Moliner (Villaverde)&quot;,</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;domicilio&quot;: &quot;Calle de Villalonso, 14&quot;,</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;codigo_postal&quot;: 28021,</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;provincia&quot;: &quot;Madrid&quot;,</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;localidad&quot;: &quot;Madrid&quot;,</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;telefono&quot;: 917230194</span></p><p class="c18"><span class="c6">&nbsp;},</span></p><p class="c18"><span class="c6">&nbsp;{</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;id&quot;: 4,</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;nombre&quot;: &quot;Residencia y centro de d&iacute;a Parque Coimbra&quot;,</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;domicilio&quot;: &quot;Avda. de los Sauces, 55&quot;,</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;codigo_postal&quot;: 28935,</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;provincia&quot;: &quot;Madrid&quot;,</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;localidad&quot;: &quot;M&oacute;stoles&quot;,</span></p><p class="c18"><span class="c6">&nbsp; &nbsp;&quot;telefono&quot;: 916461893</span></p><p class="c18"><span class="c6">&nbsp;}</span></p><p class="c18"><span class="c6">]</span></p><p class="c12"><span class="c11 c10">M&aacute;s adelante podr&iacute;amos minimizar este json para que se cargue en una sola l&iacute;nea. Tambi&eacute;n hay diversas herramientas de minify en l&iacute;nea.</span></p><h3 class="c44" id="h.ko95j29xmedd"><span class="c28">P&aacute;gina de b&uacute;squeda</span></h3><p class="c12"><span class="c11 c10">Vamos a escribir una p&aacute;gina con un formulario de b&uacute;squeda sencillo en html que permita b&uacute;squeda libre y filtrar por municipio.</span></p><p class="c12"><span class="c11 c10">Cargamos el json en un array llamado documents:</span></p><p class="c14"><span class="c4">&nbsp; &lt;script&gt;</span></p><p class="c14"><span class="c4">&nbsp; var documents= [</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; {&quot;id&quot;: 0,&quot;nombre&quot;: &quot;Biblioteca P&uacute;blica Hortaleza&quot;,&quot;domicilio&quot;: &quot;Calle Abertura, s/n&quot;,&quot;codigo_postal&quot;: 28033,&quot;provincia&quot;: &quot;Madrid&quot;,&quot;localidad&quot;: &quot;Madrid&quot;,&quot;telefono&quot;: 917633284},</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; {&quot;id&quot;: 1,&quot;nombre&quot;: &quot;Biblioteca P&uacute;blica Moratalaz&quot;,&quot;domicilio&quot;: &quot;Calle Corregidor Alonso de Tobar, 5&quot;,&quot;codigo_postal&quot;: 28030,&quot;provincia&quot;: &quot;Madrid&quot;,&quot;localidad&quot;: &quot;Madrid&quot;,&quot;telefono&quot;: 914394688},</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; {&quot;id&quot;: 2,&quot;nombre&quot;: &quot;Biblioteca P&uacute;blica Ruiz Egea (Chamber&iacute;)&quot;,&quot;domicilio&quot;: &quot;Calle de Raimundo Fern&aacute;ndez Villaverde, 6&quot;,&quot;codigo_postal&quot;: 28003,&quot;provincia&quot;: &quot;Madrid&quot;,&quot;localidad&quot;: &quot;Madrid&quot;,&quot;telefono&quot;: 915349029},</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; {&quot;id&quot;: 3,&quot;nombre&quot;: &quot;Biblioteca P&uacute;blica Mar&iacute;a Moliner (Villaverde)&quot;,&quot;domicilio&quot;: &quot;Calle de Villalonso, 14&quot;,&quot;codigo_postal&quot;: 28021,&quot;provincia&quot;: &quot;Madrid&quot;,&quot;localidad&quot;: &quot;Madrid&quot;,&quot;telefono&quot;: 917230194},</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; {&quot;id&quot;: 4,&quot;nombre&quot;: &quot;Residencia y centro de d&iacute;a Parque Coimbra&quot;,&quot;domicilio&quot;: &quot;Avda. de los Sauces, 55&quot;,&quot;codigo_postal&quot;: 28935,&quot;provincia&quot;: &quot;Madrid&quot;,&quot;localidad&quot;: &quot;M&oacute;stoles&quot;,&quot;telefono&quot;: 916461893}</span></p><p class="c14"><span class="c4">&nbsp; ] </span></p><p class="c14"><span class="c4">&nbsp; &lt;/script&gt;</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c11 c10">A continuaci&oacute;n, escribimos un formulario de b&uacute;squeda con una secci&oacute;n para mostrar los resultados. Como vamos a utilizar este c&oacute;digo sobre un gestor de contenidos Drupal nos interesa usar los estilos del componente webform que ya est&aacute;n adaptados a la identidad corporativa del portal. Tambi&eacute;n se han a&ntilde;adido clases y componentes para mejorar la accesibilidad de este formulario, como etiquetas aria.</span></p><p class="c14"><span class="c16">&lt;form </span><span class="c19">accept-charset</span><span class="c16">=</span><span class="c20">&quot;UTF-8&quot;</span><span class="c16">&nbsp;</span><span class="c19">action</span><span class="c16">=</span><span class="c20">&quot;#&quot;</span><span class="c16">&nbsp;</span><span class="c19">class</span><span class="c16">=</span><span class="c20">&quot;webform-client-form webform-client-form-99999&quot;</span><span class="c16">&nbsp;</span><span class="c19">id</span><span class="c16">=</span><span class="c20">&quot;webform-client-form-99999&quot;</span><span class="c16">&nbsp;</span><span class="c19">method</span><span class="c16">=</span><span class="c20">&quot;get&quot;</span><span class="c16">&nbsp;</span><span class="c19">onsubmit</span><span class="c16">=</span><span class="c20">&quot;return validateFormOnSubmit(this);&quot;</span><span class="c16">&nbsp;</span><span class="c19">role</span><span class="c16">=</span><span class="c20">&quot;search&quot;</span><span class="c16">&gt;</span></p><p class="c14"><span class="c15">&nbsp; </span><span class="c16">&lt;div&gt;</span></p><p class="c14"><span class="c15">&nbsp; &nbsp; </span><span class="c16">&lt;fieldset </span><span class="c19">class</span><span class="c16">=</span><span class="c20">&quot;webform-component-fieldset webform-component--datos-mensaje panel panel-default form-wrapper&quot;</span><span class="c16">&gt;</span></p><p class="c14"><span class="c15">&nbsp; &nbsp; &nbsp; </span><span class="c16">&lt;legend </span><span class="c19">class</span><span class="c16">=</span><span class="c20">&quot;panel-heading&quot;</span><span class="c16">&gt;</span><span class="c15">&nbsp;</span><span class="c16">&lt;span </span><span class="c19">class</span><span class="c16">=</span><span class="c20">&quot;panel-title fieldset-legend&quot;</span><span class="c16">&gt;</span><span class="c15">Consulta de centros de la Comunidad de Madrid:</span><span class="c16">&lt;/span&gt;</span><span class="c15">&nbsp;</span><span class="c16">&lt;/legend&gt;</span></p><p class="c14"><span class="c15">&nbsp; &nbsp; &nbsp; </span><span class="c16">&lt;div </span><span class="c19">class</span><span class="c16">=</span><span class="c20">&quot;panel-body&quot;</span><span class="c16">&gt;</span></p><p class="c14"><span class="c15">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16">&lt;div </span><span class="c19">class</span><span class="c16">=</span><span class="c20">&quot;form-item webform-component webform-component-textfield webform-component--datos-mensaje--search-lunr webform-container-inline form-group form-inline form-item form-item-submitted-datos-mensaje-search-lunr form-type-textfield form-group&quot;</span><span class="c16">&nbsp;</span><span class="c19">id</span><span class="c16">=</span><span class="c20">&quot;input-div&quot;</span><span class="c16">&gt;</span></p><p class="c14"><span class="c15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16">&lt;h1&gt;&lt;label </span><span class="c19">class</span><span class="c16">=</span><span class="c20">&quot;control-label element-invisible&quot;</span><span class="c16">&nbsp;</span><span class="c19">for</span><span class="c16">=</span><span class="c20">&quot;search-lunr&quot;</span><span class="c16">&nbsp;</span><span class="c19">htmlfor</span><span class="c16">=</span><span class="c20">&quot;search-lunr&quot;</span><span class="c16">&gt;</span><span class="c15">B&uacute;squeda de centros</span><span class="c16">&lt;/label&gt;&lt;/h1&gt;</span></p><p class="c14"><span class="c15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16">&lt;input </span><span class="c19">alt</span><span class="c16">=</span><span class="c20">&quot;Buscador de centros&quot;</span><span class="c16">&nbsp;</span><span class="c19">class</span><span class="c16">=</span><span class="c20">&quot;form-control form-text&quot;</span><span class="c16">&nbsp;</span><span class="c19">id</span><span class="c16">=</span><span class="c20">&quot;search-lunr&quot;</span><span class="c16">&nbsp;</span><span class="c19">maxlength</span><span class="c16">=</span><span class="c20">&quot;60&quot;</span><span class="c16">&nbsp;</span><span class="c19">name</span><span class="c16">=</span><span class="c20">&quot;search-lunr&quot;</span><span class="c16">&nbsp;</span><span class="c19">onchange</span><span class="c16">=</span><span class="c20">&quot;&quot;</span><span class="c16">&nbsp;</span><span class="c19">placeholder</span><span class="c16">=</span><span class="c20">&quot;B&uacute;squeda de centros&quot;</span><span class="c16">&nbsp;</span><span class="c19">size</span><span class="c16">=</span><span class="c20">&quot;30&quot;</span><span class="c16">&nbsp;</span><span class="c19">type</span><span class="c16">=</span><span class="c20">&quot;text&quot;</span><span class="c16">&gt;</span></p><p class="c14"><span class="c15">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16">&lt;/div&gt;</span></p><p class="c14"><span class="c15">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16">&lt;div </span><span class="c19">class</span><span class="c16">=</span><span class="c20">&quot;form-item form-item-submitted-municipio form-type-select form-group&quot;</span><span class="c16">&gt;</span></p><p class="c14"><span class="c15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16">&lt;select </span><span class="c19">class</span><span class="c16">=</span><span class="c20">&quot;municipio form-control form-select&quot;</span><span class="c16">&nbsp;</span><span class="c19">id</span><span class="c16">=</span><span class="c20">&quot;municipio&quot;</span><span class="c16">&nbsp;</span><span class="c19">name</span><span class="c16">=</span><span class="c20">&quot;municipio&quot;</span><span class="c16">&gt;</span></p><p class="c14"><span class="c15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16">&lt;option </span><span class="c19">value</span><span class="c16">=</span><span class="c20">&quot;&quot;</span><span class="c16">&gt;</span><span class="c15">Filtro por municipio</span><span class="c16">&lt;/option&gt;</span></p><p class="c14"><span class="c15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16">&lt;option </span><span class="c19">value</span><span class="c16">=</span><span class="c20">&quot;Madrid&quot;</span><span class="c16">&gt;</span><span class="c15">Madrid</span><span class="c16">&lt;/option&gt;</span></p><p class="c14"><span class="c15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16">&lt;option </span><span class="c19">value</span><span class="c16">=</span><span class="c20">&quot;M&oacute;stoles&quot;</span><span class="c16">&gt;</span><span class="c15">M&oacute;stoles</span><span class="c16">&lt;/option&gt;</span></p><p class="c14"><span class="c15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16">&lt;/select&gt;</span></p><p class="c14"><span class="c15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16">&lt;label </span><span class="c19">class</span><span class="c16">=</span><span class="c20">&quot;control-label element-invisible&quot;</span><span class="c16">&nbsp;</span><span class="c19">for</span><span class="c16">=</span><span class="c20">&quot;municipio&quot;</span><span class="c16">&gt;</span><span class="c15">Filtrar por municipio:</span><span class="c16">&lt;/label&gt;</span></p><p class="c14"><span class="c15">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16">&lt;/div&gt;</span></p><p class="c14"><span class="c15">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16">&lt;div </span><span class="c19">class</span><span class="c16">=</span><span class="c20">&quot;form-actions&quot;</span><span class="c16">&nbsp;</span><span class="c19">id</span><span class="c16">=</span><span class="c20">&quot;btn-div&quot;</span><span class="c16">&gt;&lt;button </span><span class="c19">class</span><span class="c16">=</span><span class="c20">&quot;webform-submit button-primary btn btn-primary form-submit&quot;</span><span class="c16">&nbsp;</span><span class="c19">id</span><span class="c16">=</span><span class="c20">&quot;btnSearch&quot;</span><span class="c16">&nbsp;</span><span class="c19">name</span><span class="c16">=</span><span class="c20">&quot;op&quot;</span><span class="c16">&nbsp;</span><span class="c19">type</span><span class="c16">=</span><span class="c20">&quot;submit&quot;</span><span class="c16">&nbsp;</span><span class="c19">value</span><span class="c16">=</span><span class="c20">&quot;Buscar&quot;</span><span class="c16">&gt;</span><span class="c15">Buscar</span><span class="c16">&lt;/button&gt;&lt;/div&gt;</span></p><p class="c14"><span class="c15">&nbsp; &nbsp; &nbsp; </span><span class="c16">&lt;/div&gt;</span></p><p class="c14"><span class="c15">&nbsp; &nbsp; </span><span class="c16">&lt;/fieldset&gt;</span></p><p class="c14"><span class="c15">&nbsp; </span><span class="c16">&lt;/div&gt;</span></p><p class="c14"><span class="c16">&lt;/form&gt;</span></p><p class="c14"><span class="c16">&lt;section </span><span class="c19">aria-label</span><span class="c16">=</span><span class="c20">&quot;Resultados de b&uacute;squeda&quot;</span><span class="c16">&gt;</span></p><p class="c14"><span class="c15">&nbsp; </span><span class="c16">&lt;div </span><span class="c19">id</span><span class="c16">=</span><span class="c20">&quot;results&quot;</span><span class="c16">&gt;</span></p><p class="c14"><span class="c15">&nbsp; &nbsp; </span><span class="c16">&lt;h2 </span><span class="c19">aria-live</span><span class="c16">=</span><span class="c20">&quot;assertive&quot;</span><span class="c16">&nbsp;</span><span class="c19">classname</span><span class="c16">=</span><span class="c20">&quot;search-results-count&quot;</span><span class="c16">&gt;</span><span class="c15">Se han encontrado N resultados</span><span class="c16">&lt;/h2&gt;</span></p><p class="c14"><span class="c15">&nbsp; &nbsp; </span><span class="c16">&lt;ul </span><span class="c19">classname</span><span class="c16">=</span><span class="c20">&quot;search-results-list&quot;</span><span class="c16">&nbsp;</span><span class="c19">id</span><span class="c16">=</span><span class="c20">&quot;list-results&quot;</span><span class="c16">&gt;&lt;/ul&gt;</span></p><p class="c14"><span class="c15">&nbsp; </span><span class="c16">&lt;/div&gt;</span></p><p class="c14"><span class="c16 c38">&lt;/section&gt;</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c10">Realizaremos la b&uacute;squeda en la funci&oacute;n </span><span class="c20">validateFormOnSubmit</span><span class="c11 c10">&nbsp;que se encargar&aacute; de:</span></p><ul class="c0 lst-kix_b2fvdmaxdt7-0 start"><li class="c12 c23"><span class="c11 c10">Recoger los valores de b&uacute;squeda introducidos por el usuario.</span></li><li class="c12 c23"><span class="c11 c10">Buscar en el &iacute;ndice de Lunr</span></li><li class="c12 c23"><span class="c11 c10">Modificar la secci&oacute;n de resultados para incluir la lista de centros</span></li><li class="c12 c23"><span class="c11 c10">Devolver false para que no se env&iacute;e el formulario.</span></li></ul><p class="c14"><span class="c4">&nbsp; &nbsp; &lt;script&gt;</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp;function validateFormOnSubmit(theForm) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // Recogemos los criterios de b&uacute;squeda</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; var query = jQuery(&#39;input#search-lunr&#39;).val();</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; var municipio = jQuery(&#39;#municipio&#39;).val();</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // Ejecutamos la b&uacute;squeda</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; var resultados= searchInLunr(query,municipio);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // Llamamos a pintar resultados pas&aacute;ndole la lista de resultados de b&uacute;squeda y la capa donde debe pintar</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; var resultdiv = jQuery(&#39;#results&#39;);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; displayResults(resultados, resultdiv);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return false;</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &lt;/script&gt;</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c10">Observar que en la funci&oacute;n anterior se est&aacute; utilizando jQuery como selector de elementos del DOM. Hay otros maneras de conseguir esta funcionalidad sin tener que importar jquery pero el portal en el que vamos a integrar esta funcionalidad ya incluye esta librer&iacute;a. Observar tambi&eacute;n que se ha modificado el selector $ por jQuery para evitar conflictos con el gestor de contenidos. De no ser as&iacute; la l&iacute;nea </span><span class="c30">jQuery(&#39;#results&#39;)</span><span class="c10">&nbsp;ser&iacute;a </span><span class="c30">$(&#39;#results&#39;).</span></p><p class="c12"><span class="c11 c10">En la funci&oacute;n displayResults nos recorremos el listado de resultados devueltos por la b&uacute;squeda y lo vamos a&ntilde;adiendo a la capa html de resultados. A&ntilde;adimos tambi&eacute;n marcado RDFa para el tipo address de schema.org</span></p><p class="c14"><span class="c4">function displayResults(result, resultdiv) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; // Limpiamos la capa de resultados</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; resultdiv.empty();</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; if (result.length&gt;0) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; // A&ntilde;adimos el mensaje que informa del n&uacute;mero de resultados obtenidos (aria-live=assertive leer&aacute; este mensaje de manera no obstrusiva en navegadores tipo jaws)</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; resultdiv.append(&#39;&lt;h3 className=&quot;search-results-count&quot; aria-live=&quot;assertive&quot;&gt;Se han encontrado &#39;+result.length+&#39; resultados&lt;\/h3&gt;&#39;);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; // A&ntilde;adimos un elemento de lista no ordenada que recuperamos a continuaci&oacute;n</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; resultdiv.append(&#39;&lt;ul className=&quot;search-results-list&quot; id=&quot;list-results&quot;&gt;&lt;\/ul&gt;&#39;);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; var listResults= jQuery(&#39;#list-results&#39;);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; // Recorremos la lista de resultados</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; for (var item in result) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; try {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // En el atributo ref del item est&aacute; almacenada la clave del elemento encontrado. Como en nuestro caso est&aacute; clave es la posici&oacute;n del elemento en el array json de documentos</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // podemos acceder a los valores que queremos mostrar con documents[ref].telefono</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; var ref = result[item].ref;</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; var searchitem=&#39;&lt;li&gt;&lt;p&gt;&lt;strong&gt;&#39;+documents[ref].nombre+&#39;&lt;/strong&gt;&lt;\/p&gt; &nbsp;&lt;div class=&quot;address&quot; property=&quot;schema:address&quot; typeof=&quot;schema:PostalAddress&quot;&gt; &nbsp;&lt;div class=&quot;field-name-field-long-address&quot;&gt;&lt;span property=&quot;schema:streetAddress&quot;&gt;&#39;+documents[ref].domicilio+&#39;&lt;\/span&gt;&lt;\/div&gt; &nbsp;&lt;div class=&quot;field-name-field-locality-address&quot;&gt;Municipio: &lt;span property=&quot;schema:addressLocality&quot;&gt;&#39;+documents[ref].localidad.toString()+&#39;&lt;\/span&gt;&lt;\/div&gt; &nbsp;&lt;div class=&quot;field-name-field-locality-region&quot;&gt;Provincia: &lt;span property=&quot;schema:addressRegion&quot;&gt;&#39;+documents[ref].provincia+&#39;&lt;\/span&gt;&lt;\/div&gt; &nbsp;&lt;div class=&quot;field-name-field-locality-postalcode&quot;&gt;C&oacute;digo postal: &lt;span property=&quot;schema:postalCode&quot;&gt;&#39;+documents[ref].codigo_postal+&#39;&lt;\/span&gt;&lt;\/div&gt; &nbsp;&lt;div class=&quot;field-name-field-locality-phone&quot;&gt;Tel&eacute;fono: &lt;span property=&quot;schema:telephone&quot; content=&quot;&#39;+documents[ref].telefono+&#39;&quot;&gt;&#39;+documents[ref].telefono+&#39;&lt;\/span&gt;&lt;\/div&gt; &lt;\/div&gt; &lt;\/div&gt;&lt;\/li&gt;&#39;;</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; listResults.append(searchitem);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } catch (error) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; console.error(error+ &#39; item: &#39;+item+&#39; ref:&#39;+ref);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; } else {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; resultdiv.append(&#39;&lt;h3 className=&quot;search-results-count&quot; aria-live=&quot;assertive&quot;&gt;No se han encontrado resultados para esta b&uacute;squeda&lt;\/h3&gt;&#39;);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; }</span></p><p class="c14"><span class="c4">}</span></p><p class="c12 c24"><span class="c4"></span></p><p class="c12"><span class="c11 c10">A continuaci&oacute;n, en la funci&oacute;n searchInLunr, vamos a montar una consulta muy simple utilizando el m&eacute;todo search. M&aacute;s adelante, veremos c&oacute;mo montar consultas con el m&eacute;todo query que nos permite una mayor refinaci&oacute;n de la b&uacute;squeda. El m&eacute;todo search admite una consulta enunciada como una cadena que puede contener modificadores y operadores que nos permiten controlar c&oacute;mo queremos filtrar y ordenar los resultados de la b&uacute;squeda.</span></p><p class="c18"><span class="c4">function searchInLunr(consulta,municipio) {</span></p><p class="c18"><span class="c4">&nbsp; &nbsp; var cadenaBusqueda= &#39;&#39;;</span></p><p class="c18"><span class="c4">&nbsp; &nbsp; if (consulta &amp;&amp; consulta.length &gt; 0) {</span></p><p class="c18"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; cadenaBusqueda += &#39;&#39;+consulta+&#39;&#39;;</span></p><p class="c18"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; if (municipio &amp;&amp; municipio.length &gt; 0) {</span></p><p class="c18"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cadenaBusqueda += &#39; +localidad:&#39;+municipio;</span></p><p class="c18"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c18"><span class="c4">&nbsp; &nbsp; } else if (municipio &amp;&amp; municipio.length &gt; 0) {</span></p><p class="c18"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; cadenaBusqueda += &#39;+localidad:&#39;+municipio;</span></p><p class="c18"><span class="c4">&nbsp; &nbsp; }</span></p><p class="c18"><span class="c4">&nbsp; &nbsp; var result = idxTDT.search(cadenaBusqueda);</span></p><p class="c18"><span class="c4">&nbsp; &nbsp; return result;</span></p><p class="c18"><span class="c4">}</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c11 c10">Si el usuario introdujera los siguientes valores en el formulario:</span></p><ul class="c0 lst-kix_cei76fufwbsa-0 start"><li class="c12 c23"><span class="c11 c10">Moratalaz en la caja de b&uacute;squeda libre</span></li><li class="c12 c23"><span class="c11 c10">Madrid en el desplegable de municipio</span></li></ul><p class="c12"><span class="c11 c10">La funci&oacute;n anterior construir&iacute;a una cadena como esta &ldquo;Moratalaz +municipio:Madrid&rdquo; que le indica a lunr que se desean todos los documentos que contengan la palabra Moratalaz y que en el campo municipio contengan obligatoriamente la palabra Madrid. Obs&eacute;rvese que si no hubi&eacute;ramos a&ntilde;adido el prefijo + delante del filtro de municipio este filtro no ser&iacute;a obligatorio y se mostrar&iacute;an todos los documentos que contuvieran la palabra Moratalaz y tambi&eacute;n todos los documentos del municipio de Madrid. Como lunr es un motor de b&uacute;squeda que realiza buenas ponderaciones de resultados, el primer documento de los resultados obtenidos ser&iacute;a el que contiene en el nombre Moratalaz y pertenece al municipio de Madrid.</span></p><p class="c12"><span class="c10">Lo que a&uacute;n no hemos hecho es cargar el &iacute;ndice de Lunr. Para poder utilizar la librer&iacute;a de b&uacute;squeda lunr.js hay que incluir el javascript espec&iacute;fico. La librer&iacute;a de lunr se encuentra en el repositorio </span><span class="c3"><a class="c21" href="https://www.google.com/url?q=https://github.com/olivernn/lunr.js/&amp;sa=D&amp;ust=1596099094026000&amp;usg=AOvVaw0zJMrgnFoPi2GZ1NN5f2Sp">https://github.com/olivernn/lunr.js/</a></span><span class="c10">&nbsp;que se puede descargar con git mediante </span><span class="c30">git clone </span><span class="c1"><a class="c21" href="https://www.google.com/url?q=https://github.com/olivernn/lunr.js.git&amp;sa=D&amp;ust=1596099094027000&amp;usg=AOvVaw3xhCEO3iMw2lssYW6gVAjr">https://github.com/olivernn/lunr.js.git</a></span></p><p class="c12"><span class="c11 c10">A continuaci&oacute;n, mostramos el c&oacute;digo que carga la librer&iacute;a e inicializa el &iacute;ndice.</span></p><p class="c14"><span class="c4">&lt;script src=&quot;https://www.comunidad.madrid/lunr/2.3.8/lunr.js&quot;&gt;&lt;/script&gt;</span></p><p class="c14"><span class="c4">&lt;script&gt;</span></p><p class="c14"><span class="c4">var idxTDT = lunr(function () {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; // Definimos los campos del &iacute;ndice (parece que store no est&aacute; soportado por lo que los campos para pintar resultados hay que sacarlos del array de documents</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.ref(&#39;id&#39;)</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.field(&#39;nombre&#39;)</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.field(&#39;domicilio&#39;)</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.field(&#39;codigo_postal&#39;)</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.field(&#39;provincia&#39;)</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.field(&#39;localidad&#39;)</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.field(&#39;telefono&#39;)</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; </span></p><p class="c14"><span class="c4">&nbsp; &nbsp; documents.forEach(function (doc) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; this.add(doc)</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; }, this)</span></p><p class="c14"><span class="c4">})</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c11 c10">Lo &uacute;nico que se hace en este fragmento de c&oacute;digo es definir el esquema de campos y recorrer el array json a&ntilde;adiendo los documentos al &iacute;ndice.</span></p><p class="c12"><span class="c11 c10">Consejo: No llamar al &iacute;ndice idx ya que puede que ya se est&eacute; utilizando. En el caso de nuestro portal sobre drupal se hac&iacute;a.</span></p><h3 class="c44" id="h.oq5agwmpf1zq"><span class="c28">An&aacute;lisis de los resultados de la b&uacute;squeda</span></h3><p class="c12"><span class="c11 c10">Analizamos ahora los siguientes casos de b&uacute;squeda:</span></p><ul class="c0 lst-kix_ye6sj6eonblf-0 start"><li class="c12 c23"><span class="c11 c10">Si buscamos &ldquo;biblioteca&rdquo; localiza las 4 bibliotecas por lo que no tiene en cuenta may&uacute;sculas y min&uacute;sculas.</span></li><li class="c12 c23"><span class="c10">Si buscamos &ldquo;biblioteca Egea&rdquo; localiza las 4 bibliotecas y muestra en primer lugar &ldquo;</span><span class="c10 c27">Biblioteca P&uacute;blica Ruiz Egea (Chamber&iacute;)</span><span class="c11 c10">&rdquo;</span></li><li class="c12 c23"><span class="c10">Si buscamos &ldquo;residencias&rdquo; localiza la &ldquo;</span><span class="c27 c10">Residencia y centro de d&iacute;a Parque Coimbra</span><span class="c11 c10">&rdquo; pese a que el nombre de centro &lsquo;Residencia&rsquo; est&aacute; en singular.</span></li><li class="c12 c23"><span class="c11 c10">Si buscamos &ldquo;28030&rdquo; nos sale &uacute;nicamente la biblioteca de Moratalaz.</span></li><li class="c12 c23"><span class="c11 c10">Si s&oacute;lo seleccionamos el municipio Madrid muestra los 4 resultados de Madrid</span></li><li class="c12 c23"><span class="c11 c10">Si seleccionamos m&oacute;stoles muestra la residencia de M&oacute;stoles.</span></li></ul><p class="c12"><span class="c11 c10">Con el juego de pruebas anterior podr&iacute;amos dar por v&aacute;lido el buscador. Vamos a utilizar un juego de pruebas mayor con m&aacute;s registros incluyendo adem&aacute;s un nuevo atributo descripci&oacute;n.</span></p><p class="c12"><span class="c11 c10">El array del nuevo juego de pruebas ser&iacute;a &eacute;ste:</span></p><p class="c14"><span class="c4">var documents= [</span></p><p class="c14"><span class="c4">{&quot;id&quot;:0,&quot;nombre&quot;:&quot;Biblioteca P&uacute;blica Hortaleza&quot;,&quot;descripcion&quot;:&quot;moratalaz&quot;,&quot;domicilio&quot;:&quot;Calle Abertura, s/n&quot;, &quot;codigo_postal&quot;:28033, &quot;provincia&quot;:&quot;Madrid&quot;, &quot;localidad&quot;:&quot;Madrid&quot;, &quot;telefono&quot;:917633284},</span></p><p class="c14"><span class="c4">{&quot;id&quot;:1,&quot;nombre&quot;:&quot;Biblioteca P&uacute;blica Moratalaz de Comunicacion&quot;,&quot;descripcion&quot;:&quot;Egea ruiz&quot;,&quot;domicilio&quot;:&quot;Calle Corregidor Alonso de Tobar, 5&quot;, &quot;codigo_postal&quot;:28030, &quot;provincia&quot;:&quot;Madrid&quot;, &quot;localidad&quot;:&quot;Madrid&quot;, &quot;telefono&quot;:914394688},</span></p><p class="c14"><span class="c4">{&quot;id&quot;:2,&quot;nombre&quot;:&quot;Biblioteca P&uacute;blica Ruiz Egea (Chamber&iacute;)&quot;,&quot;descripcion&quot;:&quot;mar&iacute;a&quot;,&quot;domicilio&quot;:&quot;Calle de Raimundo Fern&aacute;ndez Villaverde, 6&quot;,&quot;codigo_postal&quot;:28003,&quot;provincia&quot;:&quot;Madrid&quot;,&quot;localidad&quot;:&quot;Madrid&quot;,&quot;telefono&quot;:915349029},</span></p><p class="c14"><span class="c4">{&quot;id&quot;:3,&quot;nombre&quot;:&quot;Biblioteca P&uacute;blica Mar&iacute;a Moliner (Villaverde)&quot;,&quot;descripcion&quot;:&quot;mostoles&quot;,&quot;domicilio&quot;:&quot;Calle de Villalonso, 14&quot;,&quot;codigo_postal&quot;:28021,&quot;provincia&quot;:&quot;Madrid&quot;,&quot;localidad&quot;:&quot;Madrid&quot;,&quot;telefono&quot;:917230194},</span></p><p class="c14"><span class="c4">{&quot;id&quot;:4,&quot;nombre&quot;:&quot;Residencia y centro de d&iacute;a Parque Coimbra&quot;,&quot;descripcion&quot;:&quot;Siguiendo los protocolos sanitarios, los materiales en soporte f&iacute;sico pasar&aacute;n por una cuarentena de 3 d&iacute;as tras su devoluci&oacute;n, antes de estar disponible de nuevo en pr&eacute;stamo, garantizando as&iacute; la seguridad de trabajadores y usuarios. Asimismo, y con el fin de asegurar una devoluci&oacute;n escalonada de los documentos, se ha procedido a modificar la fecha de devoluci&oacute;n de los ejemplares activos hasta el lunes 7 de septiembre de 2020.&quot;,&quot;domicilio&quot;:&quot;Avda. de los Sauces, 55&quot;,&quot;codigo_postal&quot;:28935,&quot;provincia&quot;:&quot;Madrid&quot;,&quot;localidad&quot;:&quot;M&oacute;stoles&quot;,&quot;telefono&quot;:916461893},</span></p><p class="c14"><span class="c4">{&quot;id&quot;:5,&quot;nombre&quot;:&quot;Biblioteca P&uacute;blica M&oacute;stoles&quot;,&quot;descripcion&quot;:&quot;muchas casitas, comunicaci&oacute;n&quot;,&quot;domicilio&quot;:&quot;Calle de Villalonso, 14&quot;, &quot;codigo_postal&quot;:28935, &quot;provincia&quot;:&quot;Madrid&quot;, &quot;localidad&quot;:&quot;M&oacute;stoles&quot;,&quot;telefono&quot;:917230194},</span></p><p class="c14"><span class="c4">{&quot;id&quot;:6,&quot;nombre&quot;:&quot;Biblioteca de test&quot;,&quot;descripcion&quot;:&quot;Especialista en telecomunicaciones, casas, edificios, trenes, &quot;,&quot;domicilio&quot;:&quot;Avenida principal, 1&quot;,&quot;codigo_postal&quot;:28135,&quot;provincia&quot;:&quot;Madrid&quot;,&quot;localidad&quot;:&quot;Becerril de la Sierra&quot;,&quot;telefono&quot;:917230194},</span></p><p class="c14"><span class="c4">{&quot;id&quot;:7,&quot;nombre&quot;:&quot;Residencia de test 2&quot;,&quot;descripcion&quot;:&quot;CIF: A123456789&quot;,&quot;domicilio&quot;:&quot;Plaza mayor, 1&quot;,&quot;codigo_postal&quot;:28125,&quot;provincia&quot;:&quot;Madrid&quot;,&quot;localidad&quot;:&quot;San Mart&iacute;n de Valdeiglesias&quot;,&quot;telefono&quot;:917633284},</span></p><p class="c14"><span class="c4">{&quot;id&quot;:8,&quot;nombre&quot;:&quot;Residencia de test 3&quot;,&quot;descripcion&quot;:&quot;CIF: A123456789&quot;,&quot;domicilio&quot;:&quot;Plaza mayor, 1&quot;,&quot;codigo_postal&quot;:28126,&quot;provincia&quot;:&quot;Madrid&quot;,&quot;localidad&quot;:&quot;San Mart&iacute;n de la Vega&quot;,&quot;telefono&quot;:917660284}</span></p><p class="c14"><span class="c4">]</span></p><p class="c12"><span class="c11 c10">Ejecutamos a continuaci&oacute;n el siguiente juego de pruebas que no ofrecen los resultados esperados:</span></p><ul class="c0 lst-kix_c7i1dok25hqo-0 start"><li class="c12 c23"><span class="c10">Si buscamos &ldquo;egea&rdquo; el primer resultado es &ldquo;</span><span class="c27 c10">Biblioteca P&uacute;blica Moratalaz de Comunicacion</span><span class="c10">&rdquo; porque en la descripci&oacute;n hemos a&ntilde;adido el texto &ldquo;Egea&rdquo;. Deber&iacute;a mostrar primero el resultado de la biblioteca que contiene esta palabra en el t&iacute;tulo, pero </span><span class="c60 c10">a&uacute;n no hemos asignado una relevancia mayor a los campos m&aacute;s importantes</span><span class="c11 c10">&nbsp;as&iacute; que lunr, por defecto, asigna el valor 1 como relevancia a todos los campos.</span></li><li class="c12 c23"><span class="c10">Si buscamos la palabra &ldquo;publica&rdquo; no encuentra nada. En cambio, si buscamos con tilde entonces s&iacute; encontrar&aacute; 5 resultados. Esto se debe a que </span><span class="c10 c60">est&aacute; usando la gram&aacute;tica por defecto, que es la inglesa</span><span class="c11 c10">, por lo que no est&aacute; teniendo en cuenta que debe ignorar las tildes.</span></li><li class="c12 c23"><span class="c11 c10">Si buscamos la palabra &ldquo;p&uacute;blicas&rdquo; localiza los mismos 5 resultados que en el caso anterior, pero si buscamos, en cambio, la palabra &ldquo;p&uacute;blico&rdquo; no localiza nada. Esto se debe a la misma raz&oacute;n que antes: al no estar aplicando la gram&aacute;tica del castellano distingue g&eacute;nero.</span></li><li class="c12 c23"><span class="c11 c10">Si en el municipio seleccionamos San Mart&iacute;n de la Vega, nos muestra dos resultados: el correspondiente a San Mart&iacute;n de la Vega y otro de San Mart&iacute;n de Valdeiglesias. Esto se debe a que est&aacute; tokenizando los valores del campo municipio y ambos resultados contienen la palabra San.</span></li><li class="c12 c23"><span class="c11 c10">Si buscamos la palabra &ldquo;biblioteca&rdquo; nos muestra 6 resultados. Si a continuaci&oacute;n filtramos por M&oacute;stoles restringe los resultados a dos: una biblioteca (que antes tambi&eacute;n sal&iacute;a) y un residencia (que en la b&uacute;squeda anterior no se mostraba por no ser una biblioteca). El resultado esperado ser&iacute;a que nos mostrara un s&oacute;lo resultado: de las 6 bibliotecas que encontraba en la anterior b&uacute;squeda filtrara a la &uacute;nica que en el conjunto de datos hay para la ciudad de M&oacute;stoles. Este problema es complejo y lo afrontaremos al final del documento.</span></li></ul><p class="c12"><span class="c11 c10">Para analizar mejor lo que est&aacute; pasando, podemos inspeccionar con el debugger el &iacute;ndice o tambi&eacute;n podemos invocar el m&eacute;todo toJSON que exporta el &iacute;ndice completo. Vamos a mostrar algunos fragmentos:</span></p><p class="c12"><span class="c11 c10">Este es un fragmento del &iacute;ndice inverso</span></p><p class="c18"><span class="c4">94: Array [ &quot;san&quot;, {&hellip;} ]</span></p><p class="c18"><span class="c4">&#8203;&#8203;&#8203;95: Array [ &quot;sanitario&quot;, {&hellip;} ]</span></p><p class="c18"><span class="c4">&#8203;&#8203;&#8203;96: Array [ &quot;sauc&quot;, {&hellip;} ]</span></p><p class="c18"><span class="c4">&#8203;&#8203;&#8203;97: Array [ &quot;se&quot;, {&hellip;} ]</span></p><p class="c18"><span class="c4">&#8203;&#8203;&#8203;98: Array [ &quot;seguridad&quot;, {&hellip;} ]</span></p><p class="c18"><span class="c4">&#8203;&#8203;&#8203;99: Array [ &quot;septiembr&quot;, {&hellip;} ]</span></p><p class="c18"><span class="c4">&#8203;&#8203;100: Array [ &quot;sierra&quot;, {&hellip;} ]</span></p><p class="c18"><span class="c4">&#8203;&#8203;&#8203;101: Array [ &quot;siguiendo&quot;, {&hellip;} ]</span></p><p class="c18"><span class="c4">&#8203;&#8203;&#8203;102: Array [ &quot;soport&quot;, {&hellip;} ]</span></p><p class="c18"><span class="c4">&#8203;&#8203;&#8203;103: Array [ &quot;su&quot;, {&hellip;} ]</span></p><p class="c18"><span class="c4">&#8203;&#8203;&#8203;104: Array [ &quot;telecomunicacion&quot;, {&hellip;} ]</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c11 c10">Se puede ver que en efecto no se ha aplicado la gram&aacute;tica del castellano que hubiera generado ra&iacute;ces del tipo san, sanitari, telecomunicac, etc. Tambi&eacute;n se puede observar que se ha tokenizado San Mart&iacute;n de Valdeiglesias y aparece la ra&iacute;z &lsquo;san&rsquo;.</span></p><p class="c12"><span class="c11 c10">Tambi&eacute;n podemos inspeccionar la variable result que tiene una estructura por cada resultado devuelto de este tipo:</span></p><ul class="c0 lst-kix_m9hl1rm2thn6-0 start"><li class="c12 c23"><span class="c11 c10">matchdata: indicaci&oacute;n de por qu&eacute; se ha considerado que el resultado era correcto para el criterio de b&uacute;squeda.</span></li><li class="c12 c23"><span class="c11 c10">score: ponderaci&oacute;n del resultado.</span></li><li class="c12 c23"><span class="c11 c10">ref: clave o id del resultado.</span></li></ul><p class="c12"><span class="c11 c10">Si hacemos una captura con el debugger para una b&uacute;squeda filtrando en el desplegable por el municipio &lsquo;San Mart&iacute;n de la Vega&rsquo; observaremos los siguientes valores:</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 299.00px; height: 423.00px;"><img alt="" src="images/image2.png" style="width: 299.00px; height: 423.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c12"><span class="c11 c10">Al primer resultado le asigna una relevancia de 1.8226 porque encuentra en ese documento las palabras de, la, mart&iacute;n, y san. Alguna de ellas como &lsquo;de&rsquo; la encuentra tanto en el campo localidad como en el campo nombre. Al segundo resultado le asigna una relevancia de 1.0999 porque en ese documento s&oacute;lo encuentra las palabras de, mart&iacute;n, y san.</span></p><p class="c12"><span class="c11 c10">Por tanto, se puede concluir que no s&oacute;lo est&aacute; tokenizando el municipio sino que tampoco est&aacute; aplicando las stop words del castellano porque sobrevive palabras como &lsquo;de&rsquo; que deber&iacute;an haber sido eliminadas en el proceso por no ser significativas.</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c11 c10">Se puede encontrar el ejemplo completo de c&oacute;digo en el siguiente repositorio:</span></p><p class="c12"><span class="c3"><a class="c21" href="https://www.google.com/url?q=https://github.com/javierportal/lunr_manual/blob/master/src/ejemplo-basico/search.html&amp;sa=D&amp;ust=1596099094037000&amp;usg=AOvVaw3Hfr5EkoEhBs1aXjXfKPZ_">https://github.com/javierportal/lunr_manual/blob/master/src/ejemplo-basico/search.html</a></span></p><p class="c12 c24"><span class="c11 c10"></span></p><hr style="page-break-before:always;display:none;"><h2 class="c42 c62" id="h.bykvi9mx7gpb"><span class="c11 c56"></span></h2><h2 class="c42" id="h.5jlwyzsrplfw"><span class="c11 c56">Tuning y gram&aacute;tica del castellano</span></h2><h3 class="c44" id="h.dk7euelpu8iv"><span class="c28">Asignando relevancia a los campos seg&uacute;n su importancia</span></h3><p class="c12"><span class="c11 c10">Con lunr.js podemos asignar diferente relevancia a los campos tanto en tiempo de indexaci&oacute;n como en tiempo de consulta. En este apartado vamos a asignar relevancia a cada campo durante la creaci&oacute;n del &iacute;ndice que genera consultas m&aacute;s &oacute;ptimas.</span></p><p class="c14"><span class="c4">var idxTDT = lunr(function () {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; // Definimos los campos del &iacute;ndice</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.ref(&#39;id&#39;)</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.field(&#39;nombre&#39;, {boost: 12})</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.field(&#39;descripcion&#39;, {boost: 8})</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.field(&#39;domicilio&#39;)</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.field(&#39;codigo_postal&#39;)</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.field(&#39;provincia&#39;)</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.field(&#39;localidad&#39;, {boost: 5})</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.field(&#39;telefono&#39;)</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; </span></p><p class="c14"><span class="c4">&nbsp; &nbsp; documents.forEach(function (doc) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; this.add(doc)</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; }, this)</span></p><p class="c14"><span class="c4">})</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c11 c10">En el c&oacute;digo anterior se ha considerado que los campos m&aacute;s importantes del documento son nombre, descripci&oacute;n y localidad en este orden. Al resto de los campos no se les asigna ninguna relevancia por lo que tendr&iacute;an el boost por defecto (1).</span></p><p class="c12"><span class="c10">Para comprobar que est&aacute; funcionando, volvemos a hacer la consulta por la palabra &ldquo;egea&rdquo; que hac&iacute;amos en el cap&iacute;tulo anterior y el primer resultado que nos devolv&iacute;a era &ldquo;</span><span class="c27 c10">Biblioteca P&uacute;blica Moratalaz</span><span class="c10">&rdquo;. Puesto que ahora estamos dando mucho m&aacute;s peso a aquellos documentos que tienen coincidencia en el campo nombre, comprobamos que, en efecto, el primer resultado ahora es </span><span class="c27 c10">Biblioteca P&uacute;blica Ruiz Egea (Chamber&iacute;)</span><span class="c11 c10">.</span></p><p class="c12"><span class="c11 c10">Tambi&eacute;n podr&iacute;amos haber modificado la relevancia de los campos durante la consulta con una cadena de este tipo:</span></p><p class="c18"><span class="c4">idxTDT.search(&lsquo;nombre:biblioteca^12 localidad:madrid^5&rsquo;);</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c11 c10">En algunos ejemplos en internet se pueden encontrar otros atributos que se asignan a los campos durante la creaci&oacute;n del &iacute;ndice que en lunr.js no tienen ning&uacute;n efecto. Por ejemplo:</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.field(&#39;localidad&#39;, {boost: 5,store:true})</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.field(&#39;telefono&#39;, {index:false,store:true})</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c11 c10">Estos atributos le indicar&iacute;an al &iacute;ndice que debe almacenar el valor de localidad para posteriormente devolver este campo entre los atributos de los resultados de la b&uacute;squeda o que el campo telefono debe ser almacenado para ser devuelto pero no indexado porque no aporta nada a las b&uacute;squedas.</span></p><p class="c12"><span class="c11 c10">Esto se debe a una confusi&oacute;n porque otras librer&iacute;as similares, como elasticlunr.js (tambi&eacute;n basada en lunr.js) s&iacute; soportan estas funcionalidades. Los desarrolladores de lunr.js han tomado la decisi&oacute;n de no almacenar los campos en el &iacute;ndice y que el programador es responsable de mantener un repositorio separado para poder pintar posteriormente los resultados devueltos por las b&uacute;squedas. </span></p><p class="c12 c24"><span class="c11 c10"></span></p><h3 class="c44" id="h.llj3hkka8moo"><span class="c28">Algoritmo de b&uacute;squeda de lunr</span></h3><p class="c12"><span class="c11 c10">Podemos modificar o parametrizar algunas de las caracter&iacute;sticas del algoritmo de b&uacute;squeda de Lunr. En concreto tenemos las funciones k1 y b.</span></p><ul class="c0 lst-kix_tbt3fp5mpfdn-0 start"><li class="c12 c23"><span class="c11 c10">Par&aacute;metro b. Una de las hip&oacute;tesis que se asumen en este motor de b&uacute;squeda es que es mucho m&aacute;s relevante un documento en que se encuentra la palabra buscada si &eacute;ste es peque&ntilde;o. Es decir, cuanto m&aacute;s improbable es un evento, m&aacute;s significativo. Si un documento muy grande, por ejemplo, de 10.000 palabras contiene la palabra que est&aacute;s buscando no es tan relevante como si la palabra se encuentra en un documento de 4 palabras. Para reflejar esta situaci&oacute;n lunr asigna una relevancia menor cuanto mayor sea el documento. Si asignamos un valor 0 al par&aacute;metro b es equivalente a decidir que este criterio deje de aplicarse y un 1 le da una importancia muy alta.</span></li><li class="c12 c23"><span class="c11 c10">Par&aacute;metro k1. Siguiendo con este criterio general de premiar los eventos improbables, otro de los algoritmos que lunr aplica es: las palabras muy comunes no son relevantes. En el caso extremo, si entre los documentos que proporcionamos al &iacute;ndice la palabra &lsquo;Madrid&rsquo; se encuentra en todos los documentos, entonces encontrar esta palabra en alguno de ellos no tiene absolutamente ninguna relevancia. Se dice que cuando la frecuencia de una palabra es muy alta, se alcanza la saturaci&oacute;n y, por tanto, esa palabra deja de ser significativa. El par&aacute;metro k1 controla cu&aacute;n r&aacute;pido se alcanza esa saturaci&oacute;n. Valores muy bajos provocan que se alcance la saturaci&oacute;n muy r&aacute;pido mientras que valores muy altos hacen que nuestro &iacute;ndice sea m&aacute;s tolerante a la repetici&oacute;n de palabras. </span></li></ul><p class="c12"><span class="c11 c10">Por tanto, a&ntilde;adimos las siguientes l&iacute;neas al c&oacute;digo en la construcci&oacute;n del &iacute;ndice:</span></p><p class="c18"><span class="c4">&nbsp; &nbsp; &nbsp;// b: This parameter controls the importance given to the length of a document and its fields. This value must be between 0 and 1, and by default it has a value of 0.75. Reducing this value reduces the effect of different length documents on a term&rsquo;s importance to that document. </span></p><p class="c18"><span class="c4">&nbsp; &nbsp; &nbsp;// k1: This controls how quickly the boost given by a common word reaches saturation. Increasing it will slow down the rate of saturation and lower values result in quicker saturation. The default value is 1.2. If the collection of documents being indexed have high occurrences of words that are not covered by a stop word filter, these words can quickly dominate any similarity calculation. In these cases, this value can be reduced to get more balanced results. </span></p><p class="c18"><span class="c4">&nbsp; &nbsp; &nbsp;this.k1(1.2);</span></p><p class="c18"><span class="c4">&nbsp; &nbsp; &nbsp;this.b(0);</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c11 c10">Con estas l&iacute;neas de c&oacute;digo estamos dejando el par&aacute;metro k1 en su valor por defecto y asignando un valor 0 al par&aacute;metro b ya que todos nuestros documentos son peque&ntilde;os y de un tama&ntilde;o parecido.</span></p><p class="c12 c24"><span class="c11 c10"></span></p><h3 class="c44" id="h.l983wsuwtlzl"><span class="c28">Usando la gram&aacute;tica del castellano</span></h3><p class="c12"><span class="c10">Mientras que el proyecto lunr.js trata caracter&iacute;sticas generales del motor de b&uacute;squeda, existe un proyecto denominado lunr-languages que se ocupa de dar soporte a las gram&aacute;ticas de cada lenguaje espec&iacute;fico. El proyecto se encuentra en </span><span class="c3"><a class="c21" href="https://www.google.com/url?q=https://github.com/MihaiValentin/lunr-languages&amp;sa=D&amp;ust=1596099094044000&amp;usg=AOvVaw1j8hl4_oGRMfyE2FnOOg1N">https://github.com/MihaiValentin/lunr-languages</a></span><span class="c11 c10">&nbsp;y puede ser descargado mediante un git clone:</span></p><p class="c14"><span class="c4">git clone https://github.com/MihaiValentin/lunr-languages.git</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c11 c10">Para activar el soporte de la gram&aacute;tica del lenguaje castellano debemos incluir los ficheros:</span></p><p class="c14"><span class="c4">&lt;script src=&quot;https://www.comunidad.madrid/lunr/lunr.stemmer.support.js&quot;&gt;&lt;/script&gt;</span></p><p class="c14"><span class="c4">&lt;script src=&quot;https://www.comunidad.madrid/lunr/lunr.es.js&quot;&gt;&lt;/script&gt;</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c11 c10">Y en la inicializaci&oacute;n del &iacute;ndice debemos incluir la llamada a la funci&oacute;n que le indica que debe usar el pipeline del castellano:</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp;// Configuramos lenguaje castellano</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp;this.use(lunr.es);</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c11 c10">Al asignar el lenguaje se modifica el pipeline o secuencia de operaciones que se va a realizar sobre cada t&eacute;rmino analizado en la consulta y para este caso la secuencia ser&iacute;a:</span></p><ol class="c0 lst-kix_i6uk1nmxf1v5-0 start" start="1"><li class="c12 c23"><span class="c11 c10">trimmer. Limpia las palabras y elimina aquellos caracteres que no tienen sentido dentro de una palabra en castellano. Ya veremos m&aacute;s adelante que esta limpieza elimina algunos caracteres que podemos querer en algunas b&uacute;squedas.</span></li><li class="c12 c23"><span class="c11 c10">stopWordFilter. Elimina aquellas palabras que no contienen sem&aacute;ntica y por tanto no aportan a las b&uacute;squedas como art&iacute;culos, preposiciones, verbos auxiliares, etc.</span></li><li class="c12 c23"><span class="c11 c10">stemmer. Esta funci&oacute;n calcula las ra&iacute;ces de cada palabra teniendo en cuenta la gram&aacute;tica de cada idioma. Por ejemplo, para que las b&uacute;squedas sean neutras en g&eacute;nero y n&uacute;mero, se eliminan las terminaciones en &lsquo;a&rsquo;, &lsquo;o&rsquo;, &lsquo;as&rsquo;, &lsquo;os&rsquo; que son las propias del masculino y femenino singular y plural en castellano. Tambi&eacute;n elimina las part&iacute;culas reflexivas, terminaciones verbales, adverbiales, etc.</span></li></ol><p class="c12"><span class="c11 c10">En la implementaci&oacute;n actual de este m&oacute;dulo las stop words definidas son:</span></p><p class="c18"><span class="c4">a al algo algunas algunos ante antes como con contra cual cuando de del desde donde durante e el ella ellas ellos en entre era erais eran eras eres es esa esas ese eso esos esta estaba estabais estaban estabas estad estada estadas estado estados estamos estando estar estaremos estar&aacute; estar&aacute;n estar&aacute;s estar&eacute; estar&eacute;is estar&iacute;a estar&iacute;ais estar&iacute;amos estar&iacute;an estar&iacute;as estas este estemos esto estos estoy estuve estuviera estuvierais estuvieran estuvieras estuvieron estuviese estuvieseis estuviesen estuvieses estuvimos estuviste estuvisteis estuvi&eacute;ramos estuvi&eacute;semos estuvo est&aacute; est&aacute;bamos est&aacute;is est&aacute;n est&aacute;s est&eacute; est&eacute;is est&eacute;n est&eacute;s fue fuera fuerais fueran fueras fueron fuese fueseis fuesen fueses fui fuimos fuiste fuisteis fu&eacute;ramos fu&eacute;semos ha habida habidas habido habidos habiendo habremos habr&aacute; habr&aacute;n habr&aacute;s habr&eacute; habr&eacute;is habr&iacute;a habr&iacute;ais habr&iacute;amos habr&iacute;an habr&iacute;as hab&eacute;is hab&iacute;a hab&iacute;ais hab&iacute;amos hab&iacute;an hab&iacute;as han has hasta hay haya hayamos hayan hayas hay&aacute;is he hemos hube hubiera hubierais hubieran hubieras hubieron hubiese hubieseis hubiesen hubieses hubimos hubiste hubisteis hubi&eacute;ramos hubi&eacute;semos hubo la las le les lo los me mi mis mucho muchos muy m&aacute;s m&iacute; m&iacute;a m&iacute;as m&iacute;o m&iacute;os nada ni no nos nosotras nosotros nuestra nuestras nuestro nuestros o os otra otras otro otros para pero poco por porque que quien quienes qu&eacute; se sea seamos sean seas seremos ser&aacute; ser&aacute;n ser&aacute;s ser&eacute; ser&eacute;is ser&iacute;a ser&iacute;ais ser&iacute;amos ser&iacute;an ser&iacute;as se&aacute;is sido siendo sin sobre sois somos son soy su sus suya suyas suyo suyos s&iacute; tambi&eacute;n tanto te tendremos tendr&aacute; tendr&aacute;n tendr&aacute;s tendr&eacute; tendr&eacute;is tendr&iacute;a tendr&iacute;ais tendr&iacute;amos tendr&iacute;an tendr&iacute;as tened tenemos tenga tengamos tengan tengas tengo teng&aacute;is tenida tenidas tenido tenidos teniendo ten&eacute;is ten&iacute;a ten&iacute;ais ten&iacute;amos ten&iacute;an ten&iacute;as ti tiene tienen tienes todo todos tu tus tuve tuviera tuvierais tuvieran tuvieras tuvieron tuviese tuvieseis tuviesen tuvieses tuvimos tuviste tuvisteis tuvi&eacute;ramos tuvi&eacute;semos tuvo tuya tuyas tuyo tuyos t&uacute; un una uno unos vosotras vosotros vuestra vuestras vuestro vuestros y ya yo &eacute;l &eacute;ramos</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c11 c10">Posible mejora del algoritmo de stemming: Eliminar tambi&eacute;n los sufijos de diminutivos, tales como ito, ita, illo, illa, ico, ica, cito, cita, etc (y sus plurales). Tener en cuenta posibles colisiones con otras palabras para no eliminar, por ejemplo, la palabra &lsquo;cita&rsquo;.</span></p><h3 class="c44" id="h.4nii7yula5ij"><span>An&aacute;lisis de los resultados de la b&uacute;squeda</span></h3><p class="c12"><span class="c11 c10">Tras esta configuraci&oacute;n se puede comprobar que se obtienen resultados correctos tambi&eacute;n para estas b&uacute;squedas:</span></p><ul class="c0 lst-kix_oqjom6a2yix0-0 start"><li class="c12 c23"><span class="c11 c10">Si buscamos la palabra &ldquo;publica&rdquo; ahora localiza 5 resultados luego la b&uacute;squeda es correcta.</span></li><li class="c12 c23"><span class="c11 c10">Tambi&eacute;n obtenemos los 5 resultados correctos buscando por &ldquo;publico&rdquo;, &ldquo;p&uacute;blico&rdquo;, &ldquo;p&uacute;blicos&rdquo;, &ldquo;p&uacute;blicas&rdquo;, &ldquo;publicas&rdquo; y &ldquo;publica&rdquo;.</span></li><li class="c12 c23"><span class="c10">Si se busca la palabra &ldquo;garantizar&rdquo; el motor de b&uacute;squeda devuelve &ldquo;</span><span class="c27 c10">Residencia y centro de d&iacute;a Parque Coimbra</span><span class="c11 c10">&rdquo; porque contiene la palabra &lsquo;garantizando&rsquo; que es una conjugaci&oacute;n del mismo verbo.</span></li></ul><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c11 c10">En cambio, el siguiente escenario de prueba sigue fallando:</span></p><ul class="c0 lst-kix_oqjom6a2yix0-0"><li class="c12 c23"><span class="c11 c10">Si en el municipio seleccionamos San Mart&iacute;n de la Vega, nos muestra dos resultados: el correspondiente a San Mart&iacute;n de la Vega y otro de San Mart&iacute;n de Valdeiglesias. Esto se debe a que est&aacute; tokenizando los valores del campo municipio y ambos resultados contienen la palabra San.</span></li></ul><p class="c12"><span class="c11 c10">Adem&aacute;s, se ha introducido un error nuevo:</span></p><ul class="c0 lst-kix_ye6sj6eonblf-0"><li class="c12 c23"><span class="c11 c10">Si buscamos &ldquo;28030&rdquo; que antes daba como resultado la biblioteca de Moratalaz ahora no encuentra nada.</span></li></ul><p class="c12"><span class="c11 c10">Y finalmente, hay un error con la palabra comunicaci&oacute;n que analizaremos m&aacute;s tarde:</span></p><ul class="c0 lst-kix_t8id0ej4c58t-0 start"><li class="c12 c23"><span class="c11 c10">Si buscamos la palabra &ldquo;comunicaci&oacute;n&rdquo; nos muestra tres resultados:</span></li></ul><ul class="c0 lst-kix_t8id0ej4c58t-1 start"><li class="c12 c37"><span class="c38 c27 c10 c58">Biblioteca P&uacute;blica Hortaleza de Comunicaci&oacute;n</span></li><li class="c12 c37"><span class="c38 c58 c27 c10">Biblioteca P&uacute;blica Ruiz Egea (Chamber&iacute;) de comunicaciones</span></li><li class="c12 c37"><span class="c38 c58 c27 c10">Biblioteca P&uacute;blica M&oacute;stoles</span></li></ul><ul class="c0 lst-kix_t8id0ej4c58t-0"><li class="c12 c23"><span class="c11 c10">Si buscamos la palabra &ldquo;comunicaciones&rdquo; obtenemos los mismo tres resultados.</span></li><li class="c12 c23"><span class="c11 c10">Pero si buscamos la palabra &ldquo;comunicacion&rdquo; nos muestra &uacute;nicamente el siguiente resultado que tambi&eacute;n deber&iacute;a haberse mostrado en las b&uacute;squedas anteriores:</span></li></ul><ul class="c0 lst-kix_t8id0ej4c58t-1 start"><li class="c12 c37"><span class="c11 c10">Biblioteca P&uacute;blica Moratalaz de Comunicacion</span></li></ul><p class="c12 c24 c50"><span class="c11 c10"></span></p><h3 class="c44" id="h.ffydmksid8yj"><span class="c28">Filtros y c&oacute;digos postales</span></h3><p class="c12"><span class="c10">Para resolver el problema de que buscando por el municipio de San Mart&iacute;n de la Vega nos devuelva resultados correspondientes a San Mart&iacute;n de la Vega y otro de San Mart&iacute;n de Valdeiglesias tenemos que evitar que el campo localidad se tokenize. Si estuvi&eacute;ramos en Solr ser&iacute;a sencillo y bastar&iacute;a con definir ese campo como de tipo </span><span class="c22 c10">string</span><span class="c10">&nbsp;en vez de </span><span class="c22 c10">text</span><span class="c11 c10">&nbsp;para evitar que se aplicar&aacute;n los analyzers que tokenizan el valor. En Lunr no tenemos de momento esta funcionalidad. Hay varios modos de evitar esto y vamos a utilizar ambos: declarar un array para la indexaci&oacute;n y escapar los blancos para la b&uacute;squeda.</span></p><p class="c12"><span class="c11 c10">Si en el array JSON de carga del &iacute;ndice escapamos un campo como si se tratara de un array Lunr entender&aacute; que cada uno de los valores que componen el array es un valor completo que no requiere de tokenizaci&oacute;n (aunque seguir&aacute; realizando stemming como veremos m&aacute;s adelante). As&iacute; que primero vamos a escapar el campo localidad como si se tratara de un array en el JSON:</span></p><p class="c14"><span class="c4">var documents= [</span></p><p class="c14"><span class="c4">{&quot;id&quot;:0,&quot;nombre&quot;:&quot;Biblioteca P&uacute;blica Hortaleza de Comunicaci&oacute;n&quot;,&quot;descripcion&quot;:&quot;moratalaz&quot;,&quot;domicilio&quot;:&quot;Calle Abertura, s/n&quot;,&quot;codigo_postal&quot;:28033,&quot;provincia&quot;:&quot;Madrid&quot;,&quot;localidad&quot;:[&quot;Madrid&quot;],&quot;telefono&quot;:917633284},</span></p><p class="c14"><span class="c4">{&quot;id&quot;:1,&quot;nombre&quot;:&quot;Biblioteca P&uacute;blica Moratalaz de Comunicacion&quot;,&quot;descripcion&quot;:&quot;Egea ruiz&quot;,&quot;domicilio&quot;:&quot;Calle Corregidor Alonso de Tobar, 5&quot;,&quot;codigo_postal&quot;:28030,&quot;provincia&quot;:&quot;Madrid&quot;,&quot;localidad&quot;:[&quot;Madrid&quot;],&quot;telefono&quot;:914394688},</span></p><p class="c14"><span class="c4">{&quot;id&quot;:2,&quot;nombre&quot;:&quot;Biblioteca P&uacute;blica Ruiz Egea (Chamber&iacute;) de comunicaciones&quot;,&quot;descripcion&quot;:&quot;mar&iacute;a&quot;,&quot;domicilio&quot;:&quot;Calle de Raimundo Fern&aacute;ndez Villaverde, 6&quot;,&quot;codigo_postal&quot;:28003,&quot;provincia&quot;:&quot;Madrid&quot;,&quot;localidad&quot;:[&quot;Madrid&quot;],&quot;telefono&quot;:915349029},</span></p><p class="c14"><span class="c4">{&quot;id&quot;:3,&quot;nombre&quot;:&quot;Biblioteca P&uacute;blica Mar&iacute;a Moliner (Villaverde)&quot;,&quot;descripcion&quot;:&quot;mostoles&quot;,&quot;domicilio&quot;:&quot;Calle de Villalonso, 14&quot;,&quot;codigo_postal&quot;:28021,&quot;provincia&quot;:&quot;Madrid&quot;,&quot;localidad&quot;:[&quot;Madrid&quot;],&quot;telefono&quot;:917230194},</span></p><p class="c14"><span class="c4">{&quot;id&quot;:4,&quot;nombre&quot;:&quot;Residencia y centro de d&iacute;a Parque Coimbra&quot;,&quot;descripcion&quot;:&quot;Siguiendo los protocolos sanitarios, los materiales en soporte f&iacute;sico pasar&aacute;n por una cuarentena de 3 d&iacute;as tras su devoluci&oacute;n, antes de estar disponible de nuevo en pr&eacute;stamo, garantizando as&iacute; la seguridad de trabajadores y usuarios. Asimismo, y con el fin de asegurar una devoluci&oacute;n escalonada de los documentos, se ha procedido a modificar la fecha de devoluci&oacute;n de los ejemplares activos hasta el lunes 7 de septiembre de 2020.&quot;,&quot;domicilio&quot;:&quot;Avda. de los Sauces, 55&quot;,&quot;codigo_postal&quot;:28935,&quot;provincia&quot;:&quot;Madrid&quot;,&quot;localidad&quot;:[&quot;M&oacute;stoles&quot;],&quot;telefono&quot;:916461893},</span></p><p class="c14"><span class="c4">{&quot;id&quot;:5,&quot;nombre&quot;:&quot;Biblioteca P&uacute;blica M&oacute;stoles&quot;,&quot;descripcion&quot;:&quot;muchas casitas, comunicaci&oacute;n&quot;,&quot;domicilio&quot;:&quot;Calle de Villalonso, 14&quot;,&quot;codigo_postal&quot;:28935,&quot;provincia&quot;:&quot;Madrid&quot;,&quot;localidad&quot;:[&quot;M&oacute;stoles&quot;],&quot;telefono&quot;:917230194},</span></p><p class="c14"><span class="c4">{&quot;id&quot;:6,&quot;nombre&quot;:&quot;Biblioteca de test&quot;,&quot;descripcion&quot;:&quot;Especialista en telecomunicaciones, casas, edificios, trenes, &quot;,&quot;domicilio&quot;:&quot;Avenida principal, 1&quot;,&quot;codigo_postal&quot;:28135,&quot;provincia&quot;:&quot;Madrid&quot;,&quot;localidad&quot;:[&quot;Becerril de la Sierra&quot;],&quot;telefono&quot;:917230194},</span></p><p class="c14"><span class="c4">{&quot;id&quot;:7,&quot;nombre&quot;:&quot;Residencia de test 2&quot;,&quot;descripcion&quot;:&quot;CIF: A123456789&quot;,&quot;domicilio&quot;:&quot;Plaza mayor, 1&quot;,&quot;codigo_postal&quot;:28125,&quot;provincia&quot;:&quot;Madrid&quot;,&quot;localidad&quot;:[&quot;San Mart&iacute;n de Valdeiglesias&quot;],&quot;telefono&quot;:917633284},</span></p><p class="c14"><span class="c4">{&quot;id&quot;:8,&quot;nombre&quot;:&quot;Residencia de test 3&quot;,&quot;descripcion&quot;:&quot;devolver libros&quot;,&quot;domicilio&quot;:&quot;Plaza mayor, 1&quot;,&quot;codigo_postal&quot;:28126,&quot;provincia&quot;:&quot;Madrid&quot;,&quot;localidad&quot;:[&quot;San Mart&iacute;n de la Vega&quot;],&quot;telefono&quot;:917660284}</span></p><p class="c14"><span class="c30">]</span></p><p class="c12"><span class="c11 c10">Para comprobar que los municipios se est&aacute;n indexando correctamente podemos inspeccionar el &iacute;ndice con el debugger del navegador:</span></p><p class="c12"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 427.00px; height: 333.00px;"><img alt="" src="images/image1.png" style="width: 427.00px; height: 333.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c12"><span class="c11 c10">Se puede observar que no se han tokenizado ninguno de los dos municipios aunque s&iacute; se les ha aplicado el stemming del castellano suprimiendo la terminaci&oacute;n de la &uacute;ltima palabra. Tambi&eacute;n se pasa a min&uacute;sculas, se eliminan las tildes, etc.</span></p><p class="c12"><span class="c11 c10">Para realizar la b&uacute;squeda vamos a aplicar el segundo m&eacute;todo de escapar los caracteres blancos del municipio seleccionado en el desplegable. Primero escribimos una funci&oacute;n que realice esta tarea:</span></p><p class="c14"><span class="c4">function scapeSpaces(cadena) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; // El solr seg&uacute;n el tipo de campo se aplica uno u otro procesador/analizador.</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; // En lunr no veo implementada esa funcionalidad. Por tanto, para el equivalente al string de solr</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; // implementamos una funci&oacute;n que escapa los espacios para que no tokenice separando por palabras y </span></p><p class="c14"><span class="c4">&nbsp; &nbsp; // se pueda buscar sobre un campo por b&uacute;squeda exacta. OJO: No hace busqueda exacta porque hace stemming sobre</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; // la &uacute;ltima palabra, es decir, Alcal&aacute; de Henares --&gt; Alcala\\ de\\ Henares --&gt; Alcala\\ de\\ Henare</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; try {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; if (cadena &amp;&amp; cadena.length &gt; 0) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; if (Array.isArray(cadena)) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for (var item in cadena) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cadena[item]= scapeSpaces(cadena[item]);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return cadena;</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; } else {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return cadena.replace(/\s/g, &quot;\\ &quot;);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; } else {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; return &quot;&quot;;</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; }</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; } catch (error) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; console.error(error);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; }</span></p><p class="c14"><span class="c4">}</span></p><p class="c12"><span class="c11 c10">Y llamaremos a esta funci&oacute;n en el m&eacute;todo en que se recoge el valor del desplegable y se compone la query:</span></p><p class="c14"><span class="c4">function searchInLunr(consulta,municipio) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; var cadenaBusqueda= &#39;&#39;;</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; if (consulta &amp;&amp; consulta.length &gt; 0) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; cadenaBusqueda += &#39;&#39;+consulta+&#39;&#39;;</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; if (municipio &amp;&amp; municipio.length &gt; 0) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cadenaBusqueda += &#39; +localidad:&#39;+scapeSpaces(municipio);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; } else if (municipio &amp;&amp; municipio.length &gt; 0) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; cadenaBusqueda += &#39;+localidad:&#39;+scapeSpaces(municipio);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; }</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; var result = idxTDT.search(cadenaBusqueda);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; return result;</span></p><p class="c14"><span class="c4">}</span></p><p class="c12"><span class="c11 c10">Despu&eacute;s de hacer esto, las b&uacute;squedas filtrando por cualquiera de los dos municipios del ejemplo arrojan s&oacute;lo el resultado correcto.</span></p><p class="c12"><span class="c11 c10">El segundo problema que detect&aacute;bamos en la anterior fase de test era que se hab&iacute;a perdido la b&uacute;squeda por distrito postal. En realidad, al introducir la gram&aacute;tica en castellano se est&aacute;n eliminando todos los n&uacute;meros con lo que no se podr&iacute;an hacer b&uacute;squedas por conceptos NIF/DNI, tel&eacute;fonos, distritos, etc. La causa est&aacute; en la funci&oacute;n de trimmer que se ha implementado en esta librer&iacute;a y que utiliza el siguiente patr&oacute;n para saber qu&eacute; caracteres debe mantener tras el proceso de limpieza y el resto los elimina:</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; /* lunr trimmer function */</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; lunr.es.wordCharacters = &quot;A-Za-z\xAA\xBA\xC0-\xD6\xD8-\xF6\xF8-\u02B8\u02E0-\u02E4\u1D00-\u1D25\u1D2C-\u1D5C\u1D62-\u1D65\u1D6B-\u1D77\u1D79-\u1DBE\u1E00-\u1EFF\u2071\u207F\u2090-\u209C\u212A\u212B\u2132\u214E\u2160-\u2188\u2C60-\u2C7F\uA722-\uA787\uA78B-\uA7AD\uA7B0-\uA7B7\uA7F7-\uA7FF\uAB30-\uAB5A\uAB5C-\uAB64\uFB00-\uFB06\uFF21-\uFF3A\uFF41-\uFF5A&quot;;</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c11 c10">Lo m&aacute;s sencillo es tocar el una copia local la librer&iacute;a original (copia local del fichero lunr.es.js) para permitir los caracteres 0-9 en este atributo quedando del siguiente modo:</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; /* lunr trimmer function */</span></p><p class="c14"><span class="c30">&nbsp; &nbsp; lunr.es.wordCharacters = &quot;A-Za-z0-9\xAA\xBA\xC0-\xD6\xD8-\xF6\xF8-\u02B8\u02E0-\u02E4\u1D00-\u1D25\u1D2C-\u1D5C\u1D62-\u1D65\u1D6B-\u1D77\u1D79-\u1DBE\u1E00-\u1EFF\u2071\u207F\u2090-\u209C\u212A\u212B\u2132\u214E\u2160-\u2188\u2C60-\u2C7F\uA722-\uA787\uA78B-\uA7AD\uA7B0-\uA7B7\uA7F7-\uA7FF\uAB30-\uAB5A\uAB5C-\uAB64\uFB00-\uFB06\uFF21-\uFF3A\uFF41-\uFF5A&quot;;</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c10">Lo m&aacute;s correcto ser&iacute;a que hubiera diferentes tipos de atributos y dependiendo del tipo se aplicaran diferentes pipelines. Por ejemplo, podr&iacute;a haber un tipo de campo denominado </span><span class="c22 c10">alphanumber</span><span class="c10">&nbsp;al que aplicara el anterior expresi&oacute;n regular, mientras que habr&iacute;a otro tipo denominado </span><span class="c22 c10">text</span><span class="c10">&nbsp;en que la funci&oacute;n trimmer s&iacute; eliminara todos los n&uacute;meros (se podr&iacute;a definir para el campo direccion y as&iacute; eliminar&iacute;amos el n&uacute;mero del portal que puede introducir confusi&oacute;n en la b&uacute;squeda).</span></p><p class="c12"><span class="c11 c10">En esta primera aproximaci&oacute;n, lo que vamos a hacer no es ni la primera soluci&oacute;n que es muy burda ni la segunda que preferir&iacute;amos porque requiere de reescribir parte de la librer&iacute;a, sino que vamos a optar por reescribir el pipeline existente y sustituir la funci&oacute;n trimmer por una propia. Es decir: resetear el pipeline de funciones por defecto que asigna la librer&iacute;a de multilenguaje y asignar nuestras propias funciones intentando aprovechar lo m&aacute;s posible el trabajo ya realizado por los desarrolladores de lunr.js y lunr-languajes. Lo que pretendemos es sustituir la funci&oacute;n por defecto de trimmer por una nuestra que haga exactamente lo mismo pero permitiendo los caracteres num&eacute;ricos. Tambi&eacute;n hay varias formas de abordar este problema pero a continuaci&oacute;n mostramos la que nos ha parecido m&aacute;s clara:</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; // No asignamos el lenguage para que la librer&iacute;a no inicialice ning&uacute;n pipeline</span></p><p class="c14"><span class="c4">// &nbsp; &nbsp;this.use(lunr.es);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; // Definimos una expresi&oacute;n regular que mantenga los caracteres num&eacute;ricos</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; var mywordCharacters = &quot;A-Za-z0-9\xAA\xBA\xC0-\xD6\xD8-\xF6\xF8-\u02B8\u02E0-\u02E4\u1D00-\u1D25\u1D2C-\u1D5C\u1D62-\u1D65\u1D6B-\u1D77\u1D79-\u1DBE\u1E00-\u1EFF\u2071\u207F\u2090-\u209C\u212A\u212B\u2132\u214E\u2160-\u2188\u2C60-\u2C7F\uA722-\uA787\uA78B-\uA7AD\uA7B0-\uA7B7\uA7F7-\uA7FF\uAB30-\uAB5A\uAB5C-\uAB64\uFB00-\uFB06\uFF21-\uFF3A\uFF41-\uFF5A&quot;;</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; // Generamos una funci&oacute;n trimmer id&eacute;ntica a la proporcionada por la librer&iacute;a pero que usa nuestra expresi&oacute;n regular</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; var trimmerWithNumbers = lunr.trimmerSupport.generateTrimmer(mywordCharacters);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; // Registramos la nueva funci&oacute;n</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; lunr.Pipeline.registerFunction(trimmerWithNumbers, &#39;trimmerwithnumbers-es&#39;);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; // Eliminamos todas las funciones que pudiera haber en el pipeline</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.pipeline.reset();</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; // Creamos nuestro propio pipeline de funciones en el que hemos sustituido el trimmer original y hemos dejado el resto igual</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.pipeline.add(</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; trimmerWithNumbers,</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; lunr.es.stopWordFilter,</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; lunr.es.stemmer</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; );</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; // Tambi&eacute;n tenemos que crear el pipeline de b&uacute;squeda que al no haber llamado a la funci&oacute;n use(lunr.es) no se ha inicializado</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.searchPipeline.reset();</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.searchPipeline.add(lunr.es.stemmer)</span></p><p class="c12"><span class="c11 c10">De un modo muy similar podr&iacute;amos haber modificado el array de palabras de stop filter:</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; // Configuramos nuestras propias stopwords</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; mystopWordFilter = lunr.generateStopWordFilter(&#39;Madrid madrid a al algo algunas algunos ante antes como con contra cual cuando de del desde donde durante e el ella ellas ellos en entre era erais eran eras eres es esa esas ese eso esos esta estaba estabais estaban estabas estad estada estadas estado estados estamos estando estar estaremos estar&aacute; estar&aacute;n estar&aacute;s estar&eacute; estar&eacute;is estar&iacute;a estar&iacute;ais estar&iacute;amos estar&iacute;an estar&iacute;as estas este estemos esto estos estoy estuve estuviera estuvierais estuvieran estuvieras estuvieron estuviese estuvieseis estuviesen estuvieses estuvimos estuviste estuvisteis estuvi&eacute;ramos estuvi&eacute;semos estuvo est&aacute; est&aacute;bamos est&aacute;is est&aacute;n est&aacute;s est&eacute; est&eacute;is est&eacute;n est&eacute;s fue fuera fuerais fueran fueras fueron fuese fueseis fuesen fueses fui fuimos fuiste fuisteis fu&eacute;ramos fu&eacute;semos ha habida habidas habido habidos habiendo habremos habr&aacute; habr&aacute;n habr&aacute;s habr&eacute; habr&eacute;is habr&iacute;a habr&iacute;ais habr&iacute;amos habr&iacute;an habr&iacute;as hab&eacute;is hab&iacute;a hab&iacute;ais hab&iacute;amos hab&iacute;an hab&iacute;as han has hasta hay haya hayamos hayan hayas hay&aacute;is he hemos hube hubiera hubierais hubieran hubieras hubieron hubiese hubieseis hubiesen hubieses hubimos hubiste hubisteis hubi&eacute;ramos hubi&eacute;semos hubo la las le les lo los me mi mis mucho muchos muy m&aacute;s m&iacute; m&iacute;a m&iacute;as m&iacute;o m&iacute;os nada ni no nos nosotras nosotros nuestra nuestras nuestro nuestros o os otra otras otro otros para pero poco por porque que quien quienes qu&eacute; se sea seamos sean seas seremos ser&aacute; ser&aacute;n ser&aacute;s ser&eacute; ser&eacute;is ser&iacute;a ser&iacute;ais ser&iacute;amos ser&iacute;an ser&iacute;as se&aacute;is sido siendo sin sobre sois somos son soy su sus suya suyas suyo suyos s&iacute; tambi&eacute;n tanto te tendremos tendr&aacute; tendr&aacute;n tendr&aacute;s tendr&eacute; tendr&eacute;is tendr&iacute;a tendr&iacute;ais tendr&iacute;amos tendr&iacute;an tendr&iacute;as tened tenemos tenga tengamos tengan tengas tengo teng&aacute;is tenida tenidas tenido tenidos teniendo ten&eacute;is ten&iacute;a ten&iacute;ais ten&iacute;amos ten&iacute;an ten&iacute;as ti tiene tienen tienes todo todos tu tus tuve tuviera tuvierais tuvieran tuvieras tuvieron tuviese tuvieseis tuviesen tuvieses tuvimos tuviste tuvisteis tuvi&eacute;ramos tuvi&eacute;semos tuvo tuya tuyas tuyo tuyos t&uacute; un una uno unos vosotras vosotros vuestra vuestras vuestro vuestros y ya yo &eacute;l &eacute;ramos&#39;.split(&#39; &#39;));</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; // Registramos la funci&oacute;n</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; lunr.Pipeline.registerFunction(mystopWordFilter, &#39;extendedstopWordFilter-es&#39;);</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c11 c10">Tras estos cambios si ejecutamos de nuevo los juegos de prueba que no hab&iacute;a funcionado en la versi&oacute;n previa obtenemos resultados correctos:</span></p><ul class="c0 lst-kix_oqjom6a2yix0-0"><li class="c12 c23"><span class="c11 c10">Si en el desplegable de municipio seleccionamos San Mart&iacute;n de la Vega encontramos el &uacute;nico resultado correcto.</span></li></ul><ul class="c0 lst-kix_ye6sj6eonblf-0"><li class="c12 c23"><span class="c10">Si buscamos &ldquo;28030&rdquo; obtenemos de nuevo como resultado la biblioteca de Moratalaz.</span></li></ul><p class="c12"><span class="c11 c10">Tambi&eacute;n podr&iacute;amos haber modificado los caracteres que el tokenizador usa como separadores simplemente a&ntilde;adiendo una definici&oacute;n con los separadores que consideramos m&aacute;s apropiados para este caso:</span></p><p class="c14"><span class="c4">lunr.tokenizer.separator = /[\r\n|\n|\r]/</span></p><p class="c12"><span class="c11 c10">(Por defecto, los separadores son blancos y guiones lunr.tokenizer.separator = /[\s\-]+/)</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c11 c10">Se puede encontrar un ejemplo completo de c&oacute;digo en el repositorio:</span></p><p class="c12"><span class="c3"><a class="c21" href="https://www.google.com/url?q=https://github.com/javierportal/lunr_manual/blob/master/src/tunning/search.html&amp;sa=D&amp;ust=1596099094062000&amp;usg=AOvVaw0f2r_mmr4h1Pd_312TJNJ_">https://github.com/javierportal/lunr_manual/blob/master/src/tunning/search.html</a></span></p><hr style="page-break-before:always;display:none;"><h2 class="c42 c62" id="h.jmnc21z5fext"><span class="c11 c56"></span></h2><h2 class="c42" id="h.264tgsdup7s9"><span class="c11 c56">B&uacute;squeda avanzada</span></h2><h3 class="c44" id="h.9enlc5ihlmvu"><span class="c28">B&uacute;squedas difusas</span></h3><p class="c12"><span class="c11 c10">Antes de nada, vamos a dejar preparada una funci&oacute;n que se ejecutar&aacute; cuando el documento haya finalizado de cargarse en el navegador. De momento, s&oacute;lo lanzaremos una b&uacute;squeda vac&iacute;a para que se muestren todos los resultados por defecto.</span></p><p class="c14"><span class="c4">jQuery(document).ready(function() {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; validateFormOnSubmit(null);</span></p><p class="c14"><span class="c4">});</span></p><p class="c12 c24"><span class="c10 c11"></span></p><p class="c12"><span class="c11 c10">Algunos de los caracteres especiales que soporta la funci&oacute;n search para modificar el comportamiento de la b&uacute;squeda son:</span></p><ul class="c0 lst-kix_n78w9728jq9m-0 start"><li class="c12 c23"><span class="c11 c10">Comod&iacute;n. El car&aacute;cter * se utiliza como habitualmente para indicar un patr&oacute;n de b&uacute;squeda, de tal modo que *grama nos devolver&iacute;a todos los documentos que contengan palabras terminadas en grama, grama* todos los documentos con palabras que empiecen por grama y *grama* todos los documentos con palabras que contengan el fragmento grama.</span></li><li class="c12 c23"><span class="c11 c10">Relevancia. El car&aacute;cter ^ nos permite aumentar la relevancia de uno de los t&eacute;rminos, de tal modo que en la b&uacute;squeda &lsquo;foo^8 bar&rsquo; tendr&iacute;a m&aacute;s relevancia la palabra &lsquo;foo&rsquo;.</span></li><li class="c12 c23"><span class="c11 c10">Errores tipogr&aacute;ficos. El car&aacute;cter ~ permite errores tipogr&aacute;ficos, de tal modo que si el usuario escribiera una palabra err&oacute;nea el motor de b&uacute;squeda le devolver&iacute;a documentos conteniendo la palabra correcta. Esta funcionalidad es muy potente pero introduce mucho ruido en los resultados de b&uacute;squeda, sobre todo combinado con el stemming.</span></li><li class="c12 c23"><span class="c11 c10">Obligatoriedad. Con el car&aacute;cter + podemos indicarle al motor de b&uacute;squeda que la palabra a continuaci&oacute;n debe estar necesariamente en todos los documentos devueltos.</span></li><li class="c12 c23"><span class="c11 c10">Exclusi&oacute;n. Con el car&aacute;cter - podemos indicarle al motor de b&uacute;squeda que l palabra a continuaci&oacute;n no debe estar incluida en los resultados de b&uacute;squeda.</span></li></ul><p class="c12"><span class="c11 c10">El siguiente ejemplo lanza una primera b&uacute;squeda con los criterios introducidos por el usuario y esos mismos criterios con asteriscos para que tambi&eacute;n localice fragmentos de esas palabras dentro de los documentos. Si esta primera consulta no devuelve ning&uacute;n resultado entonces lanza una segunda consulta informando al usuario de que su b&uacute;squeda no obtuvo ning&uacute;n resultado pero hay documentos similares que le pueden interesar. En esta segunda consulta se permiten hasta 2 errores tipogr&aacute;ficos. Para que las diferentes funciones sepan si deben activar las b&uacute;squedas con errores tipogr&aacute;ficos o no, se les pasa una variable denominada &lsquo;difuso&rsquo; que puede valer cero (para las b&uacute;squedas normales) o uno (para las b&uacute;squedas con errores tipogr&aacute;ficos).</span></p><p class="c12"><span class="c11 c10">&Eacute;ste ser&iacute;a el fragmento de c&oacute;digo que lanza la b&uacute;squeda:</span></p><p class="c18"><span class="c4">function searchInLunr(consulta,municipio, difuso=0) {</span></p><p class="c18"><span class="c4">&nbsp; &nbsp; var cadenaBusqueda= &#39;&#39;;</span></p><p class="c18"><span class="c4">&nbsp; &nbsp; if (consulta &amp;&amp; consulta.length &gt; 0) {</span></p><p class="c18"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; cadenaBusqueda += &#39;&#39;+consulta+&#39; *&#39;+consulta+&#39;*&#39;;</span></p><p class="c18"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; if (difuso ==0) {</span></p><p class="c18"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cadenaBusqueda += &#39; &#39;+consulta+&#39;~2&#39;;</span></p><p class="c18"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c18"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; if (municipio &amp;&amp; municipio.length &gt; 0) {</span></p><p class="c18"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cadenaBusqueda += &#39; +localidad:&#39;+scapeSpaces(municipio);</span></p><p class="c18"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c18"><span class="c4">&nbsp; &nbsp; } else if (municipio &amp;&amp; municipio.length &gt; 0) {</span></p><p class="c18"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; cadenaBusqueda += &#39;+localidad:&#39;+scapeSpaces(municipio);</span></p><p class="c18"><span class="c4">&nbsp; &nbsp; }</span></p><p class="c18"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span></p><p class="c18"><span class="c4">&nbsp; &nbsp; var result = idxTDT.search(cadenaBusqueda);</span></p><p class="c18"><span class="c4">&nbsp; &nbsp; return result;</span></p><p class="c18"><span class="c4">}</span></p><p class="c12"><span class="c11 c10">Sin embargo, el c&oacute;digo anterior no ser&iacute;a correcto. Supongamos que el usuario introduce &lsquo;foo&rsquo; en la caja de b&uacute;squeda y baz en el desplegable. Entonces el c&oacute;digo anterior construir&iacute;a correctamente la siguiente cadena de b&uacute;squeda:</span></p><p class="c12"><span class="c4">&lsquo;foo *foo* +localidad:baz&rsquo;</span></p><p class="c12"><span class="c11 c10">Pero si el usuario hubiera introducido dos t&eacute;rminos en la caja de b&uacute;squeda, entonces la cadena ya no se comportar&iacute;a como queremos:</span></p><p class="c12"><span class="c4">&lsquo;foo bar *foo bar* +localidad:baz&rsquo;</span></p><p class="c12"><span class="c11 c10">Por lo que debemos recorrernos los t&eacute;rminos aplicando los operadores y tambi&eacute;n deber&iacute;amos asignar una mayor relevancia a aquellos t&eacute;rminos que no hayan sido modificados.</span></p><p class="c14"><span class="c4">function searchInLunr(consulta,municipio, difuso=0) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; var cadenaBusqueda= &#39;&#39;;</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; if (consulta &amp;&amp; consulta.length &gt; 0) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; consulta.split(&#39; &#39;).forEach(function (value) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cadenaBusqueda+= value+&#39;^12 &#39;+&#39; *&#39;+value+&#39;* *&#39;+value+&#39; &#39;+value+&#39;* &#39;;</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; });</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; if (difuso) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; consulta.split(&#39; &#39;).forEach(function (value) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cadenaBusqueda+= &#39; &#39;+value+&#39;~2&#39;;</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; });</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; if (municipio &amp;&amp; municipio.length &gt; 0) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cadenaBusqueda += &#39; +localidad:&#39;+scapeSpaces(municipio);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; } else if (municipio &amp;&amp; municipio.length &gt; 0) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; cadenaBusqueda += &#39;+localidad:&#39;+scapeSpaces(municipio);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; }</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span></p><p class="c14"><span class="c4">&nbsp; &nbsp; var result = idxTDT.search(cadenaBusqueda);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; return result;</span></p><p class="c14"><span class="c4">}</span></p><p class="c12"><span class="c11 c10">El anterior c&oacute;digo, si el usuario introdujera en la b&uacute;squeda libre &lsquo;foo bar&rsquo; construir&iacute;a la siguiente cadena:</span></p><p class="c12"><span class="c4">&lsquo;foo^12 *foo* *foo foo* bar^12 *bar* *bar bar*&rsquo;</span></p><p class="c12"><span class="c10">La raz&oacute;n por la que estamos asignando el patr&oacute;n * de esta manera se debe a que en Lunr este patr&oacute;n no significa, como habitualmente, </span><span class="c22 c10">cero o m&aacute;s ocurrencias de cualquier car&aacute;cter</span><span class="c10">&nbsp;sino </span><span class="c22 c10">una o m&aacute;s ocurrencias de cualquier car&aacute;cter</span><span class="c10">. Esto implica que si usamos el patr&oacute;n &lsquo;*biblio*&rsquo; no encontrar&aacute; las palabras que comienzan por el morfema </span><span class="c10 c22">biblio</span><span class="c10">&nbsp;que si se localizar&aacute; con el patr&oacute;n &lsquo;biblio*&rsquo;. &nbsp;El a&ntilde;adir tambi&eacute;n el patr&oacute;n &lsquo;foo*&rsquo; no tiene el comportamiento esperado. Intuitivamente podr&iacute;amos suponer que, si el ciudadano introdujera la palabra teca, nos encontrar&aacute; todas las palabras terminadas en teca. No se comporta de este modo debido al stemming y a que, desgraciadamente, Lunr no guarda las palabras originales en el &iacute;ndice. Es decir, en el &iacute;ndice no habr&aacute; ninguna palabra terminada en </span><span class="c22 c10">teca</span><span class="c10">&nbsp;porque Lunr ha almacenado la ra&iacute;z </span><span class="c22 c10">bibliotec</span><span class="c11 c10">.</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c11 c10">Se puede consultar un ejemplo de c&oacute;digo en el siguiente repositorio:</span></p><p class="c12"><span class="c3"><a class="c21" href="https://www.google.com/url?q=https://github.com/javierportal/lunr_manual/blob/master/src/avanzado/search.html&amp;sa=D&amp;ust=1596099094070000&amp;usg=AOvVaw0b4tBI4pCubVDgnaBsIr7v">https://github.com/javierportal/lunr_manual/blob/master/src/avanzado/search.html</a></span></p><p class="c12 c24"><span class="c11 c10"></span></p><h3 class="c44" id="h.n9diwfpo4my5"><span class="c28">Construcci&oacute;n de Query program&aacute;ticamente</span></h3><p class="c12"><span class="c11 c10">La funci&oacute;n search internamente construye una query similar a la que vamos a construir a continuaci&oacute;n compuesta de t&eacute;rminos y atributos que modifican el comportamiento de la consulta. Los atributos permitidos en la construcci&oacute;n de los t&eacute;rminos nos proporcionan algunas funcionalidades que no estaban disponibles en la for,a anterior como el atributo usePipeline que indica al motor de b&uacute;squeda si debe o no usar el pipeline de funciones para el t&eacute;rmino especificado. Probamos primero con este fragmento:</span></p><p class="c14"><span class="c4">function searchInLunr(consulta,municipio, difuso=0) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp;</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; var result = idxTDT.query(function (q) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; if (consulta &amp;&amp; consulta.length &gt; 0) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; consulta.split(&#39; &#39;).forEach(function (value) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; q.term(value, { boost: 32 }) // exact match</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; q.term(value, { usePipeline: false, wildcard: lunr.Query.wildcard.TRAILING, boost: 8 }) // prefix match, no stemmer</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; q.term(value, { usePipeline: false, wildcard: lunr.Query.wildcard.LEADING, boost: 4 }) // suffix match, no stemmer</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; q.term(value, { usePipeline: false, wildcard: lunr.Query.wildcard.LEADING | lunr.Query.wildcard.TRAILING, boost: 2 }) // suffix and prefix match, no stemmer</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (difuso) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; q.term(value, { usePipeline: false, editDistance: value.length&gt;6?2:1, boost: 1 }) // fuzzy matching</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; });</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (municipio &amp;&amp; municipio.length &gt; 0) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; q.term(municipio, { fields: [&quot;localidad&quot;], usePipeline: false, presence: lunr.Query.presence.REQUIRED })</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; } else if (municipio &amp;&amp; municipio.length &gt; 0) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; q.term(municipio, { fields: [&quot;localidad&quot;], usePipeline: false, presence: lunr.Query.presence.REQUIRED })</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; });</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; </span></p><p class="c14"><span class="c4">&nbsp; &nbsp; return result;</span></p><p class="c14"><span class="c4">}</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c10">Como se puede observar en vez de usar el operador * usamos </span><span class="c30">lunr.Query.wildcard.TRAILING y lunr.Query.wildcard.LEADING</span><span class="c11 c10">&nbsp;con el atributo wildcard para indicar el equivalente al asterisco delante o detr&aacute;s del t&eacute;rmino.</span></p><p class="c12"><span class="c11 c10">Con el atributo boost estamos modificando la relevancia de los t&eacute;rminos, de modo que asignamos una mayor relevancia a la b&uacute;squeda &ldquo;exacta&rdquo; (no es exacta en realidad porque se est&aacute; aplicando el pipeline definido para modificar el t&eacute;rmino), una menor para las palabras que empiezan por el t&eacute;rmino, menor a&uacute;n para las palabras que finalizan por el t&eacute;rmino, m&aacute;s peque&ntilde;a para las palabras que contienen el t&eacute;rmino y una muy baja para las palabras que se diferencian en algunos caracteres.</span></p><p class="c12"><span class="c10">&nbsp;Con el atributo presence y los valores </span><span class="c30">lunr.Query.presence.REQUIRED, </span><span class="c30">lunr.Query.presence.OPTIONAL y </span><span class="c30">lunr.</span><span class="c30">Query</span><span class="c30">.presence.PROHIBITED</span><span class="c30">&nbsp;</span><span class="c11 c10">podemos especificar que un t&eacute;rmino sea obligatorio, opcional o que los documentos que contengan el t&eacute;rmino sean excluidos de los resultados.</span></p><p class="c12"><span class="c11 c10">Para especificar que el t&eacute;rmino s&oacute;lo debe ser buscado en un campo (o campos) concreto del documento la sintaxis es q.term(valor, {fields:[&ldquo;campo1&rdquo;, &ldquo;campo2&rdquo;]}).</span></p><p class="c12"><span class="c11 c10">Vamos a analizar un poco m&aacute;s es uso del atributo usePipeline. Se puede observar que en aquellos t&eacute;rminos en que estamos usando wildcards estamos especificando que no use pipeline para tratar el t&eacute;rmino. Esto est&aacute; bien, aunque es redundante porque Lunr nunca usa pipeline cuando un t&eacute;rmino tiene asociado un wildcard. Recordemos que en un test anterior no hab&iacute;amos conseguido que el motor nos devolviera las bibliotecas usando la palabra &lsquo;teca&rsquo; porque al aplicar el pipeline durante la indexaci&oacute;n los morfmas almacenados para la palabra biblioteca eran del tipo &lsquo;bibliotec&rsquo;. Usando esta construcci&oacute;n del objeto Query nos pasa lo mismo: puesto que Lunr ha aplicado el pipeline al indexar y no lo est&aacute; aplicando sobre el t&eacute;rmino con wildcard vuelve a no haber coincidencia.</span></p><p class="c12"><span class="c11 c10">Tambi&eacute;n se puede observar que en el caso de la b&uacute;squeda por municipio hemos eliminado la funci&oacute;n de escapar blancos. La estrategia era: si para el campo localidad no aplicamos pipeline ni al indexar ni al buscar, entonces habr&aacute; coincidencia sin necesidad de escapar los blancos. Por eso hemos hecho la siguiente modificaci&oacute;n en la carga del &iacute;ndice:</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.ref(&#39;id&#39;)</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.field(&#39;nombre&#39;, {boost: 12})</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.field(&#39;descripcion&#39;, {boost: 8})</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.field(&#39;domicilio&#39;)</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.field(&#39;codigo_postal&#39;)</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.field(&#39;provincia&#39;)</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.field(&#39;localidad&#39;, {usePipeline: false, boost: 5})</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.field(&#39;telefono&#39;)</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c11 c10">Es decir, le hemos indicado a Lunr que no use pipeline para indexar el campo localidad. Desgraciadamente, Lunr ignora este &uacute;ltimo atributo por lo que va a seguir aplicando stemming sobre los municipios por lo que se va a indexar &ldquo;san martin de la veg&rdquo; mientras que se va a buscar por el t&eacute;rmino &ldquo;San Mart&iacute;n de la Vega&rdquo;.</span></p><p class="c12"><span class="c10">Con el par&aacute;metro editDistance configuramos el n&uacute;mero de errores que se pueden cometer al escribir un t&eacute;rmino y que a&uacute;n as&iacute; Lunr detecte coincidencia. Con </span><span class="c30">value.length&gt;6?2:1</span><span class="c11 c10">&nbsp;somos m&aacute;s permisivos con las palabras largas que con las cortas.</span></p><p class="c12"><span class="c11 c10">Internamente, Lunr genera una estructura de objetos clauses como se puede ver en la siguiente figura:</span></p><p class="c12"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 234.00px; height: 548.00px;"><img alt="" src="images/image3.png" style="width: 234.00px; height: 548.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c12"><span class="c11 c10">que encapsula todos los atributos que hemos definido durante la construcci&oacute;n de la query.</span></p><p class="c12"><span class="c11 c10">A continuaci&oacute;n escribimos una versi&oacute;n del m&eacute;todo de b&uacute;squeda que implementa algunas mejoras con respecto al anterior:</span></p><p class="c14"><span class="c4">function searchInLunr(consulta,municipio, difuso=0) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; var result = idxTDT.query(function (q) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; if (consulta &amp;&amp; consulta.length &gt; 0) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; consulta.split(&#39; &#39;).forEach(function (value) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; q.term(value, { boost: 32 }) // exact match</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; q.term(value, { usePipeline: false, wildcard: lunr.Query.wildcard.TRAILING, boost: 8 }) // prefix match, no stemmer</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; q.term(value, { usePipeline: false, wildcard: lunr.Query.wildcard.LEADING, boost: 4 }) // suffix match, no stemmer</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; q.term(value, { usePipeline: false, wildcard: lunr.Query.wildcard.LEADING | lunr.Query.wildcard.TRAILING, boost: 2 }) // suffix and prefix match, no stemmer</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (difuso) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; q.term(value, { usePipeline: true, wildcard: lunr.Query.wildcard.LEADING, boost: 4 }) // suffix match, stemmer</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; q.term(value, { usePipeline: false, editDistance: value.length&gt;6?2:1, boost: 1 }) // fuzzy matching</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; });</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (municipio &amp;&amp; municipio.length &gt; 0) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; q.term(municipio.toLowerCase(), { fields: [&quot;localidad&quot;], usePipeline: true, presence: lunr.Query.presence.REQUIRED })</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; } else if (municipio &amp;&amp; municipio.length &gt; 0) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; q.term(municipio.toLowerCase(), { fields: [&quot;localidad&quot;], usePipeline: true, presence: lunr.Query.presence.REQUIRED })</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; } &nbsp; </span></p><p class="c14"><span class="c4">&nbsp; &nbsp; })</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; return result;</span></p><p class="c14"><span class="c4">}</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c11 c10">Las modificaciones son:</span></p><ul class="c0 lst-kix_q6e5llwbj00b-0 start"><li class="c12 c23"><span class="c11 c10">Para la b&uacute;squeda por municipio no es necesario escapar blancos porque no se va a tokenizar (tokenizar es tarea nuestra, una vez que creamos el t&eacute;rmino Lunr considera que ya est&aacute; tokenizado) pero debemos pasar a min&uacute;sculas ya que esta tarea se realizaba en la fase de tokenizaci&oacute;n. Como hemos a&ntilde;adido que use pipeline se van a generar t&eacute;rminos de este tipo &ldquo;san martin de la veg&rdquo; que machea con el municipio indexado.</span></li><li class="c12 c23"><span class="c11 c10">En el bloque de b&uacute;squeda difusa hemos a&ntilde;adido las siguientes l&iacute;neas:</span></li></ul><p class="c14"><span class="c4">q.term(value, { usePipeline: true, wildcard: lunr.Query.wildcard.LEADING, boost: 4 })</span></p><p class="c12"><span class="c11 c10">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Con esto, lo que conseguimos es hacer stemming para sufijos. Es decir, si ahora escribimos la palabra de b&uacute;squeda teca, Lunr lanzar&aacute; la b&uacute;squeda y no encontrar&aacute; resultados por lo cual se lanzar&aacute; una segunda b&uacute;squeda m&aacute;s amplia que incluir&aacute; la b&uacute;squeda de palabras que terminan en stemming(teca) que es tec y por tanto habr&aacute; coincidencia con la ra&iacute;z almacenada en el &iacute;ndice inverso que es bibliotec.</span></p><p class="c12 c24"><span class="c11 c10"></span></p><h3 class="c44" id="h.drfszcjkeyxv"><span>Paginaci&oacute;n</span></h3><p class="c12"><span class="c11 c10">Lunr no proporciona ning&uacute;n mecanismo para realizar la paginaci&oacute;n de los resultados por lo que debemos implementar uno por fuera.</span></p><p class="c12"><span class="c11 c10">Vamos a crear una funci&oacute;n showPager a la que llamaremos antes y despu&eacute;s de pintar los resultados de este modo:</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; resultdiv.empty();</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; showPager(resultdiv, resultados, currentPage);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; displayResults(resultados, resultdiv, difuso, currentPage);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; showPager(resultdiv, resultados, currentPage);</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c11 c10">A la funci&oacute;n le pasamos la capa en la que tiene que pintar, los resultados y la p&aacute;gina actual que se est&aacute; mostrando.</span></p><p class="c12"><span class="c11 c10">La funci&oacute;n tendr&aacute; esta forma:</span></p><p class="c14"><span class="c4">function showPager(capa, result, currentPage) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; // Mostramos un pagnador simple</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; var numPages= Math.ceil(result.total/result.resultsPerPage);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; // S&oacute;lo pintamos el paginador si hay m&aacute;s de una p&aacute;gina</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; if (numPages&gt;1) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; var pagerElements= &quot;&quot;;</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; pagerElements += &#39;&lt;div class=&quot;resultpager&quot;&gt;&lt;ul&gt;&#39;;</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; for (i=0; i &lt; numPages; i++) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pageLoop= i+1;</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (i==currentPage) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pagerElements += &#39;&lt;li class=&quot;item-page selected&quot;&gt;&#39;+pageLoop+&#39;&lt;\/li&gt;&#39;;</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pagerElements += &#39;&lt;li class=&quot;item-page&quot;&gt;&#39;+pageLoop+&#39;&lt;\/li&gt;&#39;;</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; pagerElements += &#39;&lt;\/ul&gt;&lt;\/div&#39;;</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; capa.append(pagerElements);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; $(&#39;.resultpager li&#39;).css(&#39;cursor&#39;, &#39;pointer&#39;);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; $(&#39;.resultpager li&#39;).click(function() {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; var selectedPage= this.innerText;</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; validateFormOnSubmit(null,selectedPage-1);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return false;</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; });</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; }</span></p><p class="c14"><span class="c4">}</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c11 c10">Hay que explicar que la variable resultados ya no es un array de los elementos devueltos por la consulta. Ahora es una estructura que contiene tres propiedades:</span></p><ul class="c0 lst-kix_veh6wb5gno53-0 start"><li class="c12 c23"><span class="c11 c10">resultsPerPage: Es el n&uacute;mero de elementos por p&aacute;gina.</span></li><li class="c12 c23"><span class="c11 c10">total: Es el n&uacute;mero de elementos devuelto por la consulta.</span></li><li class="c12 c23"><span class="c10">currentResults: Es la lista de los elementos que hay que pintar para la p&aacute;gina actual.</span></li></ul><p class="c14 c24"><span class="c4"></span></p><p class="c12"><span class="c11 c10">Esta funci&oacute;n hace lo habitual de pintar una lista de elementos para cada uno de los n&uacute;meros asignando la clase selected a la p&aacute;gina actual para que despu&eacute;s se le pueda aplicar un estilo diferente al resto. Tambi&eacute;n hace a cada uno de los elementos de la lista clicable y que asigna una funci&oacute;n que se ejecutar&aacute; en el evento de onclick. Esta funci&oacute;n recoge el valor del elemento de la lista que se corresponde con la p&aacute;gina que quiere visualizar el usuario y llama a la funci&oacute;n que tiene toda la l&oacute;gica de b&uacute;squeda y representaci&oacute;n de resultados.</span></p><p class="c12"><span class="c11 c10">Para extraer del array devuelto por Lunr los resultados que se corresponden a la p&aacute;gina actual se realiza esta operaci&oacute;n:</span></p><p class="c14"><span class="c4">resultados.currentResults = result.slice(page * resultados.resultsPerPage, (page * resultados.resultsPerPage) + resultados.resultsPerPage);</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c11 c10">Ahora vamos a a&ntilde;adir un listener que vaya ejecutando las b&uacute;squedas a medida que el usuario vaya escribiendo con el siguiente fragmento de c&oacute;digo y otro listener para ejecutar la b&uacute;squeda cuando se produce una selecci&oacute;n en el desplegable:</span></p><p class="c14"><span class="c4">jQuery(document).ready(function() {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; validateFormOnSubmit(null);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; jQuery(&quot;#search-lunr&quot;).on(&quot;search paste keyup&quot;, function(event) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; var st = $(this).val();</span></p><p class="c14 c24"><span class="c4"></span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; if (st.length === 0) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; validateFormOnSubmit(null);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; } else {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // make it async, otherwise the keyboard input is interrupted</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; setTimeout(function() {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; validateFormOnSubmit(null);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }, 100);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; });</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; jQuery(&quot;#municipio&quot;).on(&quot;change&quot;,function(event) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; validateFormOnSubmit(null);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; });</span></p><p class="c14 c24"><span class="c4"></span></p><p class="c14"><span class="c4">});</span></p><p class="c12 c24"><span class="c11 c10"></span></p><h3 class="c44" id="h.ccfgqxr0zw5c"><span class="c28">Trabajando con fechas</span></h3><p class="c12"><span class="c11 c10">Lunr no trabaja con diferentes tipos de campos y en el &iacute;ndice todo se almacena como un string, por tanto, tampoco trabaja con datos de tipo fecha. A&uacute;n as&iacute;, el el siguiente ejemplo vamos a mostrar como hacer un filtro por a&ntilde;os para lo que vamos a a&ntilde;adir un nuevo campo denominado fecha al JSON inicial en formato DD/MM/YYYY y usar un extractor para formatear un nuevo campo de a&ntilde;o que se almacene en el &iacute;ndice.</span></p><p class="c12"><span class="c11 c10">Un extractor es una de las herramientas que nos proporciona Lunr para personalizar los algoritmos por defecto. Los extractores se pueden asociar a un campo concreto tal que se ejecuten en tiempo de indexaci&oacute;n d&aacute;ndonos la opci&oacute;n de modificar los datos del JSON antes de devolv&eacute;rselos a Lunr.</span></p><p class="c12"><span class="c11 c10">Puesto que hemos modificado el comportamiento del motor de indexaci&oacute;n para que no elimine los n&uacute;meros al procesar los campos (recordemos que el trimmer del lenguaje castellano no permit&iacute;a caracteres alfanum&eacute;ricos) los valores del nuevo campo fecha se van a almacenar correctamente y funcionar&aacute; consultas de este tipo: idxTDT.search(&lsquo;fecha:*2020&rsquo;). En lugar de eso, vamos a crear un nuevo campo &ldquo;en el aire&rdquo; en el que vamos a almacenar s&oacute;lo el a&ntilde;o.</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; // Definimos los campos del &iacute;ndice (parece que store no est&aacute; a&uacute;n soportado por lo que los campos para pintar resultados hay que sacarlos del array de documents</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.ref(&#39;id&#39;)</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.field(&#39;nombre&#39;, {boost: 12})</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.field(&#39;descripcion&#39;, {boost: 8})</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.field(&#39;domicilio&#39;)</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.field(&#39;codigo_postal&#39;)</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.field(&#39;provincia&#39;)</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.field(&#39;localidad&#39;, {usePipeline: false, boost: 5})</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.field(&#39;telefono&#39;)</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.field(&#39;fecha&#39;)</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.field(&#39;year&#39;,{</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; extractor: function (doc) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; var currentYear= doc.fecha.substring(doc.fecha.lastIndexOf(&#39;/&#39;)+1);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // Debemos a&ntilde;adir este nuevo campo tambi&eacute;n al array JSON si queremos pintarlo posteriormente</span></p><p class="c14"><span class="c4">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;doc.year= currentYear;</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return currentYear;</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; })</span></p><p class="c12"><span class="c11 c10">Este nuevo campo s&oacute;lo tiene sentido para realizar b&uacute;squedas ya que para presentar esta informaci&oacute;n ya tenemos el campo fecha. Cuando creamos un campo &ldquo;en el aire&rdquo; debemos analizar si se trata de un campo representable y, en ese caso, a&ntilde;adirlo al almacen de documentos que en este caso es el array JSON como se puede observar en las l&iacute;neas comentadas del fragmento de c&oacute;digo anterior.</span></p><p class="c12"><span class="c11 c10">Una versi&oacute;n m&aacute;s &oacute;ptima para este caso en que el campo no es almacnado ser&iacute;a:</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; this.field(&#39;year&#39;,{</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; extractor: function (doc) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return doc.fecha.substring(doc.fecha.lastIndexOf(&#39;/&#39;)+1);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; })</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c11 c10">&nbsp;Tambi&eacute;n tenemos que modificar la consulta para a&ntilde;adir este nuevo filtro:</span></p><p class="c14"><span class="c4">function searchInLunr(consulta, municipio, year, difuso=0, page=0) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; var resultados= new Object();</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; resultados.resultsPerPage= 2;</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; var result = idxTDT.query(function (q) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; if (consulta &amp;&amp; consulta.length &gt; 0) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; consulta.split(&#39; &#39;).forEach(function (value) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; q.term(value, { boost: 32 }) // exact match</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; q.term(value, { usePipeline: false, wildcard: lunr.Query.wildcard.TRAILING, boost: 8 }) // prefix match, no stemmer</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; q.term(value, { usePipeline: false, wildcard: lunr.Query.wildcard.LEADING, boost: 4 }) // suffix match, no stemmer</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; q.term(value, { usePipeline: false, wildcard: lunr.Query.wildcard.LEADING | lunr.Query.wildcard.TRAILING, boost: 2 }) // suffix and prefix match, no stemmer</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (difuso) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; q.term(value, { usePipeline: true, wildcard: lunr.Query.wildcard.LEADING, boost: 4 }) // suffix match, no stemmer</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; q.term(value, { usePipeline: false, editDistance: value.length&gt;6?2:1, boost: 1 }) // fuzzy matching</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; });</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; if (municipio &amp;&amp; municipio.length &gt; 0) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; q.term(municipio.toLowerCase(), { fields: [&quot;localidad&quot;], usePipeline: true, presence: lunr.Query.presence.REQUIRED })</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; } &nbsp; </span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; if (year &amp;&amp; year.length &gt; 0) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; q.term(year, { fields: [&quot;year&quot;], usePipeline: false, presence: lunr.Query.presence.REQUIRED })</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; } &nbsp; </span></p><p class="c14"><span class="c4">&nbsp; &nbsp; })</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; </span></p><p class="c14"><span class="c4">&nbsp; &nbsp; resultados.currentResults = result.slice(page * resultados.resultsPerPage, (page * resultados.resultsPerPage) + resultados.resultsPerPage);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; resultados.total= result.length;</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; return resultados;</span></p><p class="c14"><span class="c4">}</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c11 c10">Aunque los mantenedores de la librer&iacute;a han analizado c&oacute;mo implementar en el futuro b&uacute;squedas de intervalos num&eacute;ricos como, por ejemplo, &lsquo;devuelve todos los documentos con precios entre 5 y 10&rsquo;, esta funcionalidad actualmente no est&aacute; soportada. En lo que se refiere a b&uacute;squeda de documentos por intervalos de fechas no queda m&aacute;s remedio que hacer cosas del tipo:</span></p><p class="c14"><span class="c30">idxTDT.search(&lsquo;year:2017 year:2018 year:2019&rsquo;);</span></p><p class="c12"><span class="c11 c10">para hacer b&uacute;squedas de todos los documentos comprendidos entre 2017 y 2019.</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c11 c10">Se puede localizar un ejemplo de c&oacute;digo en el siguiente repositorio:</span></p><p class="c12"><span class="c3"><a class="c21" href="https://www.google.com/url?q=https://github.com/javierportal/lunr_manual/blob/master/src/avanzado/query.html&amp;sa=D&amp;ust=1596099094095000&amp;usg=AOvVaw3w2BwZWg4zhx2CAMCVjomI">https://github.com/javierportal/lunr_manual/blob/master/src/avanzado/query.html</a></span></p><h3 class="c44" id="h.k30939new0es"><span class="c28">Documentos destacados</span></h3><p class="c12"><span class="c11 c10">Podemos asignar una relevancia m&aacute;s alta a ciertos documentos en tiempo de indexaci&oacute;n. El API de adici&oacute;n de documentos permite indicar un atributo de relevancia que quedar&aacute; asociado al documento y servir&aacute; para modificar la ponderaci&oacute;n que Lunr le ha asignado a ese documento en cada b&uacute;squeda. La manera m&aacute;s sencilla se ilustra mediante el siguiente fragmento de b&uacute;squeda:</span></p><p class="c14 c24"><span class="c4"></span></p><p class="c9"><span class="c4">var idx = lunr(function () {</span></p><p class="c14"><span class="c4">&nbsp;this.ref(&#39;name&#39;)</span></p><p class="c14"><span class="c4">&nbsp; this.field(&#39;text&#39;)</span></p><p class="c14 c24"><span class="c4"></span></p><p class="c14"><span class="c4">&nbsp; &nbsp; documents.forEach(function (doc) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; this.add(doc, { boost: boostValue })</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; }, this)</span></p><p class="c14"><span class="c4">})</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c11 c10">Por ejemplo, si la relevancia estuviera almacenada en un campo de los documentos el c&oacute;digo ser&iacute;a:</span></p><p class="c12"><span class="c10">&nbsp;</span><span class="c4">var idx = lunr(function () {</span></p><p class="c14"><span class="c4">&nbsp;this.ref(&#39;name&#39;)</span></p><p class="c14"><span class="c4">&nbsp; this.field(&#39;text&#39;)</span></p><p class="c14 c24"><span class="c4"></span></p><p class="c14"><span class="c4">&nbsp; &nbsp; documents.forEach(function (doc) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; this.add(doc, { boost: doc.relevancia })</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; }, this)</span></p><p class="c14"><span class="c4">})</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c11 c10">El uso adecuado de esta funcionalidad es destacar o promocionar determinados documentos, de tal modo que si los criterios de b&uacute;squeda lo identifican como un documento que cumple condiciones para devolverse como resultado, &eacute;ste salga entre los primeros. Se puede ajustar el boost para que incluso salga siempre el primero.</span></p><p class="c12"><span class="c11 c10">Adem&aacute;s de esta manera de asignar relevancia a cada documento tambi&eacute;n existe otro m&eacute;todo basado en que el propio JSON se estructure en forma de tuplas documento, boost de este modo:</span></p><p class="c14"><span class="c7 c38">documents = [</span></p><p class="c14"><span class="c7 c38">&nbsp; &nbsp; {</span></p><p class="c14"><span class="c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c15 c25">&#39;id&#39;</span><span class="c7">: </span><span class="c15 c25">&#39;0&#39;</span><span class="c7 c38">,</span></p><p class="c14"><span class="c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c15 c25">&#39;title&#39;</span><span class="c7">: </span><span class="c15 c25">&#39;T&iacute;tulo del primer documento&#39;</span><span class="c7 c38">,</span></p><p class="c14"><span class="c7 c38">&nbsp; &nbsp; }, </span></p><p class="c14"><span class="c7 c38">&nbsp; &nbsp; {</span></p><p class="c14"><span class="c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c15 c25">&#39;id&#39;</span><span class="c7">: </span><span class="c15 c25">&#39;1&#39;</span><span class="c7 c38">,</span></p><p class="c14"><span class="c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c15 c25">&#39;title&#39;</span><span class="c7">: </span><span class="c15 c25">&#39;T&iacute;tulo del segundo documento&#39;</span><span class="c7 c38">,</span></p><p class="c14"><span class="c7 c38">&nbsp; &nbsp; }, </span></p><p class="c14"><span class="c7 c38">&nbsp; &nbsp; (</span></p><p class="c14"><span class="c7 c38">&nbsp; &nbsp; &nbsp; &nbsp; {</span></p><p class="c14"><span class="c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c15 c25">&#39;id&#39;</span><span class="c7">: </span><span class="c15 c25">&#39;2&#39;</span><span class="c7 c38">,</span></p><p class="c14"><span class="c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c15 c25">&#39;title&#39;</span><span class="c7">: </span><span class="c15 c25">&#39;T&iacute;tulo del tercer documento&#39;</span><span class="c7 c38">,</span></p><p class="c14"><span class="c7 c38">&nbsp; &nbsp; &nbsp; &nbsp; }, {</span></p><p class="c14"><span class="c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c15 c25">&#39;boost&#39;</span><span class="c7">: </span><span class="c15 c59">10</span></p><p class="c14"><span class="c7 c38">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c14"><span class="c7 c38">&nbsp; &nbsp; )]</span></p><p class="c5 c61"><span class="c11 c10">Obs&eacute;rvese que la estructura del tercer documento es una tupla formada por el documento y el boost correspondiente. Al resto de documento que no especifican ninguna relevancia se les asigna 1 por defecto.</span></p><p class="c12"><span class="c11 c10">El propio autor de la librer&iacute;a ha indicado en alguna ocasi&oacute;n que esta t&eacute;cnica podr&iacute;a servir para realizar una ordenaci&oacute;n por defecto de los documentos devueltos en el array de b&uacute;squeda. Es decir, si dos documentos tuvieran el mismo peso en los resultados este boost del documento podr&iacute;a servir para forzar una ordenaci&oacute;n concreta, por ejemplo, mostrar antes los m&aacute;s recientes. Hay que tener en cuenta que esta relevancia que se asigna al documento en tiempo de indexaci&oacute;n afecta y modifica el peso de los docuemntos en todas las b&uacute;squedas que se realicen, por lo que utilizar este mecanismo para forzar una ordenaci&oacute;n no nos parece el m&aacute;s adecuado. En caso de usarse, se aconseja que se usen multiplicadores muy peque&ntilde;os y que no haya gran diferencia entre la relevancia asignada al menos relevante de los documentos y el m&aacute;s relevante, mediante el uso de decimales en el boost (boost:1.0000010).</span></p><p class="c12"><span class="c10">Lo m&aacute;s adecuado para solucionar el problema anterior ser&iacute;a poder especificar una clausula orderby (al estilo de Solr) en la consulta de modo que se especificaran los conceptos por los que ordenar los resultados. Por ejemplo: orderby:[&ldquo;relevance&rdquo;,&rdquo;otro_campo_del_doc&rdquo;] que significar&iacute;a que la lista de resultados se va a devolver ordenada por relevancia y, a igualdad de relevancia, por un campo num&eacute;rico que se ha especificado en el documento (por ejemplo ref).</span></p><h3 class="c44" id="h.lsek4mokcmi9"><span class="c28">Serializaci&oacute;n</span></h3><p class="c12"><span class="c11 c10">Un &iacute;ndice se puede serializar de tal modo que se puede cargar m&aacute;s adelante. Por ejemplo, podr&iacute;amos generar un &iacute;ndice pesado en una aplicaci&oacute;n de backend (por ejemplo, en drupal) y dejarlo accesible por https. El buscador incrustado en la p&aacute;gina podr&iacute;a recoger ese fichero y cargarlo con javascript en una funci&oacute;n.</span></p><p class="c12"><span class="c11 c10">Hay que tener en cuenta que tambi&eacute;n deber&iacute;a cargar el JSON de los documentos porque ya hemos visto que Lunr no almacena la informacion para presentar posteriormente los resultados.</span></p><p class="c12"><span class="c11 c10">El metodo para serializar el &iacute;ndice es:</span></p><p class="c14"><span class="c4">JSON.stringify(idxTDT);</span></p><p class="c14 c24"><span class="c4"></span></p><p class="c12"><span class="c11 c10">As&iacute; que podemos hacer un m&eacute;todo que cree un enlace de descarga del fichero serializado del &iacute;ndice del siguiente modo:</span></p><p class="c14"><span class="c4">function downloadIndex() {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; var serializedIndex= JSON.stringify(idxTDT);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; // crear el fichero con la API File</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; var file = new Blob([serializedIndex],{type:&quot;text/plain;charset=utf-8&quot;});</span></p><p class="c14 c24"><span class="c4"></span></p><p class="c14"><span class="c4">&nbsp; &nbsp; // Obtener una URL para el fichero que acabas de crear</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; var url &nbsp;= window.URL.createObjectURL(file);</span></p><p class="c14 c24"><span class="c4"></span></p><p class="c14"><span class="c4">&nbsp; &nbsp; // crear un enlace y lo a&ntilde;ades al documento</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; var a = document.createElement(&quot;a&quot;);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; </span></p><p class="c14"><span class="c4">&nbsp; &nbsp; jQuery(&quot;#descarga&quot;).append(a);</span></p><p class="c14 c24"><span class="c4"></span></p><p class="c14"><span class="c4">&nbsp; &nbsp; // actualizar los par&aacute;metros del enlace para descargar el fichero creado</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; a.href = url;</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; a.innerHTML = &quot;Descargar fichero&quot;;</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; a.download = file.name;</span></p><p class="c14"><span class="c4">}</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c10">Para cargar el &iacute;ndice habr&iacute;a que llamar a la unci&oacute;n load del siguiente modo:</span></p><p class="c12"><span class="c11 c10">var idxTDT = lunr.Index.load(JSON.parse(serializedIndex))</span></p><p class="c12"><span class="c11 c10">Cargar un &iacute;ndice ya construido es bastante m&aacute;s r&aacute;pido que construirlo desde cero por lo que esto puede ser &uacute;til en algunos casos, para algunos &iacute;ndices muy grandes.</span></p><p class="c12 c24"><span class="c11 c10"></span></p><h3 class="c44" id="h.dja0qib5bhv7"><span class="c28">Los filtros no funcionan</span></h3><p class="c12"><span class="c11 c10">Ya en el primer cap&iacute;tulo encontr&aacute;bamos este problema con la combinaci&oacute;n de b&uacute;squeda libre de texto y selecci&oacute;n en el desplegable:</span></p><ul class="c0 lst-kix_c7i1dok25hqo-0"><li class="c12 c23"><span class="c11 c10">Si buscamos la palabra &ldquo;biblioteca&rdquo; nos muestra 6 resultados. Si a continuaci&oacute;n filtramos por M&oacute;stoles restringe los resultados a dos: una biblioteca (que antes tambi&eacute;n sal&iacute;a) y un residencia (que en la b&uacute;squeda anterior no se mostraba por no ser una biblioteca). El resultado esperado ser&iacute;a que nos mostrara un s&oacute;lo resultado: de las 6 bibliotecas que encontraba en la anterior b&uacute;squeda filtrara a la &uacute;nica que en el conjunto de datos hay para la ciudad de M&oacute;stoles. </span></li></ul><p class="c12"><span class="c11 c10">El problema se debe a que Lunr no tiene un mecanismo de asiciaci&oacute;n de operadores l&oacute;gicos apropiado y parece que no lo va a implementar en el futuro pr&oacute;ximo. Vamos a explicar un poco mejor qu&eacute; significa esto.</span></p><p class="c12"><span class="c11 c10">Tal y como estamos construyendo las b&uacute;squedas hasta el momento son del tipo:</span></p><p class="c12"><span class="c11 c10">&lsquo;foo bar +field:baz&rsquo;</span></p><p class="c12"><span class="c10">Es decir, &ldquo;obt&eacute;n todos los documentos que contienen obligatoriamente la palabra </span><span class="c22 c10">baz</span><span class="c10">&nbsp;en el campo especificado y adem&aacute;s pueden contener en cualquier otro campo </span><span class="c22 c10">foo</span><span class="c10">&nbsp;y </span><span class="c22 c10">bar</span><span class="c10">&rdquo;, cuando lo que nos gustar&iacute;a es algo como &ldquo;obt&eacute;n todos los documentos que contienen obligatoriamente la palabra </span><span class="c22 c10">baz</span><span class="c10">&nbsp;en el campo especificado y adem&aacute;s obligatoriamente contienen en cualquier otro campo o la palabra </span><span class="c22 c10">foo</span><span class="c10">&nbsp;o la palabra </span><span class="c22 c10">bar</span><span class="c11 c10">&nbsp;o ambas&rdquo;. Esto expresado con la sintaxis anterior ser&iacute;a:</span></p><p class="c12"><span class="c11 c10">&lsquo;+(foo bar) +field:baz&rsquo;</span></p><p class="c12"><span class="c11 c10">que es el tipo de operaciones que no es posible realizar con Lunr.</span></p><p class="c12"><span class="c11 c10">As&iacute; que s&oacute;lo hay dos maneras de afrontar este problema:</span></p><ul class="c0 lst-kix_1emiwc70v2fc-0 start"><li class="c12 c23"><span class="c11 c10">La primera soluci&oacute;n es que los t&eacute;rminos que se extraen de la caja de b&uacute;squeda libre de texto sean todos obligatorios, es decir, algo de este tipo: &lsquo;+foo +bar +field:baz&rsquo;, de tal modo que el buscador devolviera siempre los contenidos que contienen todos los t&eacute;minos. Esto no es lo habitual en los buscadores modernos que ordenan los documentos por relevancia mostrando arriba los que tienen m&aacute;s coincidencia aunque no tengan todos los t&eacute;rminos de la b&uacute;squeda, pero puede servir en algun caso.</span></li><li class="c12 c23"><span class="c11 c10">La segunda soluci&oacute;n pasa por lanzar dos b&uacute;squedas: una primero con todos los documentos que se ajustan a la consulta &lsquo;foo bar&rsquo;, luego lanzar una segunda consulta de todos los documentos que se ajustan a &lsquo;+field:baz&rsquo; y, finalmente, recorrerse el array del primer resultado y eliminar los documentos que no est&eacute;n en el segundo array.</span></li></ul><p class="c12"><span class="c11 c10">Vamos a implementar la segunda soluci&oacute;n que es la que tiene algo m&aacute;s de dificultad. A continuaci&oacute;n se muestra la funci&oacute;n searchInLunr tras esta modificaci&oacute;n:</span></p><p class="c14"><span class="c4">function searchInLunr(consulta, municipio, year, difuso=0, page=0) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; var resultados= new Object();</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; resultados.resultsPerPage= 2;</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; // Ejecutamos una consulta con los t&eacute;rminos de la caja de b&uacute;squeda</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; var results = idxTDT.query(function (q) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; if (consulta &amp;&amp; consulta.length &gt; 0) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; consulta.split(&#39; &#39;).forEach(function (value) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; q.term(value, { boost: 32 }) // exact match</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; q.term(value, { usePipeline: false, wildcard: lunr.Query.wildcard.TRAILING, boost: 8 }) // prefix match, no stemmer</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; q.term(value, { usePipeline: false, wildcard: lunr.Query.wildcard.LEADING, boost: 4 }) // suffix match, no stemmer</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; q.term(value, { usePipeline: false, wildcard: lunr.Query.wildcard.LEADING | lunr.Query.wildcard.TRAILING, boost: 2 }) // suffix and prefix match, no stemmer</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (difuso) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; q.term(value, { usePipeline: true, wildcard: lunr.Query.wildcard.LEADING, boost: 4 }) // suffix match, no stemmer</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; q.term(value, { usePipeline: false, editDistance: value.length&gt;6?2:1, boost: 1 }) // fuzzy matching</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; });</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; })</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; // Ejecutamos una segunda consulta con los t&eacute;rminos procedentes de los dos filtros</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; var results2 = idxTDT.query(function (q) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; if (municipio &amp;&amp; municipio.length &gt; 0) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; q.term(municipio.toLowerCase(), { fields: [&quot;localidad&quot;], usePipeline: true, presence: lunr.Query.presence.REQUIRED })</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; if (year &amp;&amp; year.length &gt; 0) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; q.term(year, { fields: [&quot;year&quot;], usePipeline: false, presence: lunr.Query.presence.REQUIRED })</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; })</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; // Eliminamos del primer array aquellos documentos que no est&aacute;n en el segundo.</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; results = results.filter(function (result1) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; return results2.some(function (result2) {</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; return result2.ref === result1.ref;</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; &nbsp; })</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; });</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; // Del array completo de documentos devuelto por las consultas anteriores vamos a extraer </span></p><p class="c14"><span class="c4">&nbsp; &nbsp; // el fragmento correspondiente &uacute;nicamente con la p&aacute;gina que vamos a presentar</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; resultados.currentResults = results.slice(page * resultados.resultsPerPage, (page * resultados.resultsPerPage) + resultados.resultsPerPage);</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; resultados.total= results.length;</span></p><p class="c14"><span class="c4">&nbsp; &nbsp; return resultados;</span></p><p class="c14"><span class="c4">}</span></p><p class="c14 c24"><span class="c4"></span></p><p class="c12"><span class="c10">Tras este cambio, ya funciona correctamente la b&uacute;squeda libre con filtrados con desplegables, tambi&eacute;n conocidas como b&uacute;squedas facetadas, aunque en este contexto las b&uacute;squedas facetadas tienen otro significado.</span></p><p class="c12 c24"><span class="c11 c10"></span></p><p class="c12"><span class="c11 c10">Se puede localizar un ejemplo de c&oacute;digo en el siguiente repositorio:</span></p><p class="c12"><span class="c3"><a class="c21" href="https://www.google.com/url?q=https://github.com/javierportal/lunr_manual/blob/master/src/avanzado/filtros.html&amp;sa=D&amp;ust=1596099094111000&amp;usg=AOvVaw1yrZtpWE49GB2RtuPd_iCp">https://github.com/javierportal/lunr_manual/blob/master/src/avanzado/filtros.html</a></span></p><hr style="page-break-before:always;display:none;"><h2 class="c42 c62" id="h.acmcbbu1szf"><span class="c11 c56"></span></h2><h2 class="c42" id="h.2tl60doo6kvr"><span class="c11 c56">Consideraciones finales</span></h2><p class="c12 c24"><span class="c11 c10"></span></p><h3 class="c44" id="h.yawyqdsgfzvx"><span class="c28">Mejoras en la librer&iacute;a</span></h3><p class="c12"><span class="c11 c10">Algunas mejoras que proponemos a esta librer&iacute;a son:</span></p><ul class="c0 lst-kix_mvx7bf7jy6x0-0 start"><li class="c12 c23"><span class="c10">A&ntilde;adir sintaxis al m&eacute;todo search que permita agrupar comportamiento de los t&eacute;rminos. Por ejemplo, la cadena &lsquo;+(bar foo baz) +field:other&rsquo; buscar&iacute;a todos los documentos que contuvieran al menos una de las palabras entre par&eacute;ntesis y que adem&aacute;s tuvieran un valor determinado para uno de los campos.</span></li><li class="c12 c23"><span class="c10">A&ntilde;adir un tipo de campo </span><span class="c22 c10">string</span><span class="c10">&nbsp;para el que no se aplique la tokenizaci&oacute;n, otro </span><span class="c22 c10">alphanumber</span><span class="c10">&nbsp;que mantendr&iacute;a los caracteres num&eacute;ricos y otro normal con los pipelines por defecto denominado </span><span class="c22 c10">text</span><span class="c10">. Habr&iacute;a que pensar c&oacute;mo hacer un </span><span class="c22 c10">date</span><span class="c11 c10">.</span></li><li class="c12 c23"><span class="c11 c10">Lo anterior tambi&eacute;n se podr&iacute;a implementar permitiendo que hubiera un pipeline diferente por cada campo.</span></li><li class="c12 c23"><span class="c11 c10">Especificar un campo que sirva para la ordenaci&oacute;n por defecto de los campos. Algo as&iacute; como que se pudiera a&ntilde;adir a la query una clausula orderby. Por ejemplo: &lsquo;foo bar field:baz orderby:[relevance,otro_campo]&rsquo;</span></li><li class="c12 c23"><span class="c10">Incluir sintaxis para hacer consultas con rangos num&eacute;ricos, del tipo &lsquo;foo bar field:[10..50]&rsquo;. Este tipo de funcionalidad podria trasladarse a busqueda de cotenidos entre dos fechas trasladando las fechas a milisegundos-UNIX.</span></li></ul><h3 class="c44" id="h.clccx59huqch"><span class="c28">Otras librer&iacute;as</span></h3><p class="c12"><span class="c11 c10">Existen otras librer&iacute;as que funcionan de un modo similar a Lunr o que extienden Lunar que pueden ser m&aacute;s adecuadas para otros prop&oacute;sitos.</span></p><p class="c12"><span class="c38 c58 c27 c10">Elasticlunr</span></p><p class="c12"><span class="c10">Esta librer&iacute;a extiende lunr.js y puede localizarse en </span><span class="c3"><a class="c21" href="https://www.google.com/url?q=http://elasticlunr.com/&amp;sa=D&amp;ust=1596099094114000&amp;usg=AOvVaw2j6PC_zRLdYNO5sGH-K8rb">http://elasticlunr.com/</a></span><span class="c11 c10">&nbsp;</span></p><p class="c12"><span class="c38 c58 c27 c10">Fuse</span></p><p class="c12"><span class="c10">Librer&iacute;a m&aacute;s especializada en b&uacute;squedas difusas. </span><span class="c3"><a class="c21" href="https://www.google.com/url?q=https://fusejs.io/&amp;sa=D&amp;ust=1596099094114000&amp;usg=AOvVaw2THv9h0dYHYynOIlLK4v5K">https://fusejs.io/</a></span><span class="c11 c10">&nbsp;</span></p><p class="c12"><span class="c38 c58 c27 c10">Pounchdb</span></p><p class="c12"><span class="c10">En este caso se trata de una base de datos en javascript que es capaz de sincronizarse cuando el dispositivo est&aacute; online con el backend pero es capaz de trabajar offline. </span><span class="c3"><a class="c21" href="https://www.google.com/url?q=https://pouchdb.com/&amp;sa=D&amp;ust=1596099094115000&amp;usg=AOvVaw2IK4lY7lZ4mHnyL2U4k4lS">https://pouchdb.com/</a></span></p><p class="c12"><span class="c38 c58 c27 c10">Leaflet</span></p><p class="c12"><span class="c10">Se trata de una librer&iacute;a open source que nos permitir&iacute;a integrar las b&uacute;squedas con mapas. </span><span class="c3"><a class="c21" href="https://www.google.com/url?q=https://leafletjs.com/&amp;sa=D&amp;ust=1596099094115000&amp;usg=AOvVaw2z5Edyw6s9o-zmFNhYVKB3">https://leafletjs.com/</a></span></p><div><p class="c24 c33"><span class="c2"></span></p></div></body></html>